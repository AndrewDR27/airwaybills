<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Setup - Airway Bills</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .setup-container {
            background: white;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            width: 100%;
            max-width: 500px;
        }
        .setup-container h1 {
            margin: 0 0 10px 0;
            color: #333;
            text-align: center;
        }
        .setup-container p {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
            font-size: 14px;
        }
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 500;
        }
        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
            box-sizing: border-box;
        }
        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }
        .btn-create {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .btn-create:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        .error-message {
            background: #fee;
            color: #c33;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }
        .success-message {
            background: #efe;
            color: #3c3;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }
        .warning-box {
            background: #fff3cd;
            border: 1px solid #ffc107;
            color: #856404;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 13px;
        }
    </style>
</head>
<body>
    <div class="setup-container">
        <h1>üîê Admin User Setup</h1>
        <p>Create an administrator account</p>
        
        <div class="warning-box" id="infoBox">
            <strong>‚ÑπÔ∏è Information:</strong> <span id="infoText">Checking for existing admin accounts...</span>
        </div>
        
        <div class="error-message" id="errorMessage"></div>
        <div class="success-message" id="successMessage"></div>
        
        <form id="adminSetupForm">
            <div class="form-group">
                <label for="name">Full Name</label>
                <input type="text" id="name" name="name" required>
            </div>
            <div class="form-group">
                <label for="email">Email</label>
                <input type="email" id="email" name="email" required autocomplete="email">
            </div>
            <div class="form-group">
                <label for="company">Company (Optional)</label>
                <input type="text" id="company" name="company">
            </div>
            <div class="form-group">
                <label for="password">Password</label>
                <input type="password" id="password" name="password" required autocomplete="new-password" minlength="6">
            </div>
            <div class="form-group">
                <label for="confirmPassword">Confirm Password</label>
                <input type="password" id="confirmPassword" name="confirmPassword" required autocomplete="new-password" minlength="6">
            </div>
            <button type="submit" class="btn-create">Create Admin User</button>
        </form>
        
        <div style="text-align: center; margin-top: 20px; padding-top: 20px; border-top: 1px solid #e0e0e0;">
            <p style="font-size: 14px; color: #666; margin-bottom: 10px;">Already have an account?</p>
            <a href="login.html" style="color: #667eea; text-decoration: none; font-weight: 500;">Login here</a>
            <br><br>
            <a href="register.html" style="color: #667eea; text-decoration: none; font-weight: 500; font-size: 14px;">Or register a regular user account</a>
        </div>
    </div>

    <!-- Load required scripts -->
    <script src="models/user.js"></script>
    <script src="js/roles.js"></script>
    <script src="js/auth.js"></script>
    <script type="module">
        import { usersAPI } from './js/api.js';
        
        // Make usersAPI available globally
        window.usersAPI = usersAPI;
        
        // Also expose checkForAdmins globally for debugging
        window.checkForAdmins = async function() {
            try {
                if (!usersAPI) return false;
                const users = await usersAPI.getAll();
                if (!Array.isArray(users)) return false;
                const admins = users.filter(u => u && u.role === 'admin');
                return admins.length > 0;
            } catch (error) {
                console.error('Error checking for admins:', error);
                return false;
            }
        };
        
        // Check if any admin accounts exist
        async function checkForAdmins() {
            try {
                // Wait for API to be ready
                if (!usersAPI) {
                    console.log('usersAPI not ready yet, assuming no admins exist');
                    return false;
                }
                
                const users = await usersAPI.getAll();
                if (!Array.isArray(users)) {
                    console.log('Users API returned non-array, assuming no admins exist');
                    return false;
                }
                
                const admins = users.filter(u => u && u.role === 'admin');
                console.log(`Found ${admins.length} admin(s) in database`);
                return admins.length > 0;
            } catch (error) {
                console.error('Error checking for admins:', error);
                // If API fails, assume no admins exist (allow first admin creation)
                return false;
            }
        }
        
        // Check authentication and admin status
        (async () => {
            const infoText = document.getElementById('infoText');
            const infoBox = document.getElementById('infoBox');
            
            try {
                // Wait a moment for API to initialize
                await new Promise(resolve => setTimeout(resolve, 300));
                
                const hasAdmins = await checkForAdmins();
                
                if (!hasAdmins) {
                    // No admins exist - allow anyone to create the first admin
                    infoText.textContent = 'No admin accounts exist. You can create the first admin account. This will be stored in the database.';
                    infoBox.style.background = '#d1ecf1';
                    infoBox.style.borderColor = '#0c5460';
                    infoBox.style.color = '#0c5460';
                    // Don't require authentication for first admin
                    console.log('No admins found - allowing first admin creation');
                    return;
                }
                
                // Admins exist - require admin authentication
                console.log('Admins exist - checking authentication');
                infoText.textContent = 'Only existing administrators can create new admin accounts. You must be logged in as an admin to access this page. Admin accounts are now stored in the database and shared across all devices.';
                
                // Wait a bit more for auth functions to be available
                await new Promise(resolve => setTimeout(resolve, 500));
                
                if (typeof isAuthenticated === 'undefined') {
                    console.warn('isAuthenticated function not available');
                    // If auth functions aren't loaded, allow access (might be first time setup)
                    infoText.textContent = 'No admin accounts exist. You can create the first admin account. This will be stored in the database.';
                    infoBox.style.background = '#d1ecf1';
                    infoBox.style.borderColor = '#0c5460';
                    infoBox.style.color = '#0c5460';
                    return;
                }
                
                if (!isAuthenticated()) {
                    console.log('User not authenticated - redirecting to login');
                    alert('You must be logged in as an admin to create additional admin accounts.');
                    window.location.href = 'login.html';
                    return;
                }
                
                const user = await getCurrentUserAsync();
                if (!user || user.role !== 'admin') {
                    console.log('User is not admin - redirecting');
                    alert('Only administrators can access this page.');
                    window.location.href = 'dashboard.html';
                    return;
                }
                
                console.log('Admin authenticated - access granted');
            } catch (error) {
                console.error('Error in admin check:', error);
                // If there's any error, assume no admins exist and allow access
                infoText.textContent = 'No admin accounts exist. You can create the first admin account. This will be stored in the database.';
                infoBox.style.background = '#d1ecf1';
                infoBox.style.borderColor = '#0c5460';
                infoBox.style.color = '#0c5460';
                console.log('Error occurred - allowing access for first admin creation');
            }
        })();
        
        document.getElementById('adminSetupForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const name = document.getElementById('name').value.trim();
            const email = document.getElementById('email').value.trim();
            const company = document.getElementById('company').value.trim();
            const password = document.getElementById('password').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const errorMessage = document.getElementById('errorMessage');
            const successMessage = document.getElementById('successMessage');
            const submitButton = e.target.querySelector('button[type="submit"]');
            
            // Hide messages
            errorMessage.style.display = 'none';
            successMessage.style.display = 'none';
            
            // Validation
            if (password !== confirmPassword) {
                errorMessage.textContent = 'Passwords do not match';
                errorMessage.style.display = 'block';
                return;
            }
            
            if (password.length < 6) {
                errorMessage.textContent = 'Password must be at least 6 characters';
                errorMessage.style.display = 'block';
                return;
            }
            
            // Disable button during submission
            submitButton.disabled = true;
            submitButton.textContent = 'Creating Admin...';
            
            try {
                // Check if email already exists
                try {
                    const existing = await usersAPI.getByEmail(email);
                    if (existing) {
                        errorMessage.textContent = 'Email already registered';
                        errorMessage.style.display = 'block';
                        submitButton.disabled = false;
                        submitButton.textContent = 'Create Admin User';
                        return;
                    }
                } catch (checkError) {
                    // User doesn't exist, continue
                }
                
                // Create admin user via API
                const userData = {
                    name: name,
                    email: email,
                    role: 'admin',
                    company: company || '',
                    password: password
                };
                
                const newUser = await usersAPI.register(userData);
                
                if (newUser) {
                    successMessage.textContent = '‚úÖ Admin user created successfully in database!';
                    successMessage.style.display = 'block';
                    
                    // If this is the first admin, offer to log in
                    const hasAdmins = await checkForAdmins();
                    if (!hasAdmins || (await usersAPI.getAll()).filter(u => u.role === 'admin').length === 1) {
                        successMessage.textContent += ' This is your first admin account. You can now log in.';
                        setTimeout(() => {
                            if (confirm('Would you like to log in as this admin now?')) {
                                window.location.href = 'login.html';
                            }
                        }, 1000);
                    }
                    
                    // Reset form
                    document.getElementById('adminSetupForm').reset();
                } else {
                    throw new Error('Failed to create admin user');
                }
            } catch (error) {
                console.error('Error creating admin user:', error);
                errorMessage.textContent = error.message || 'Failed to create admin user. Please try again.';
                errorMessage.style.display = 'block';
            } finally {
                submitButton.disabled = false;
                submitButton.textContent = 'Create Admin User';
            }
        });
    </script>
</body>
</html>
