<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Airlines - Airway Bills</title>
    <link rel="stylesheet" href="styles.css">
    <script type="module" src="js/themes.js"></script>
    <style>
        body {
            margin: 0;
            padding: 2px;
            font-family: 'MS Sans Serif', 'Arial', sans-serif;
            background: #008080;
            background-image: 
                repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(0,0,0,0.02) 2px, rgba(0,0,0,0.02) 4px);
            min-height: 100vh;
        }
        .airlines-container {
            max-width: 1200px;
            margin: 0 auto;
            background: #C0C0C0;
            border: 2px outset #C0C0C0;
            overflow: hidden;
        }
        .airlines-header {
            background: linear-gradient(to bottom, #000080 0%, #000080 100%);
            color: white;
            padding: 4px 8px;
            text-align: center;
            border-bottom: 2px solid #000000;
        }
        .airlines-header h1 {
            font-size: 16px;
            margin-bottom: 2px;
            font-weight: bold;
            font-family: 'MS Sans Serif', Arial, sans-serif;
        }
        .airlines-content {
            padding: 8px;
        }
        .airlines-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        .btn-add {
            padding: 4px 16px;
            background: #C0C0C0;
            color: #000000;
            border: 2px outset #C0C0C0;
            font-size: 11px;
            font-weight: normal;
            cursor: pointer;
            font-family: 'MS Sans Serif', Arial, sans-serif;
        }
        .btn-add:hover {
            background: #E8E8E8;
        }
        .btn-add:active {
            border: 2px inset #C0C0C0;
            background: #808080;
        }
        .airlines-list {
            background: white;
            overflow: hidden;
            border: 2px inset #C0C0C0;
        }
        .airlines-table {
            width: 100%;
            border-collapse: collapse;
        }
        .airlines-table thead {
            background: #C0C0C0;
            border-bottom: 2px inset #C0C0C0;
        }
        .airlines-table th {
            padding: 4px 8px;
            text-align: left;
            font-weight: bold;
            color: #000000;
            font-size: 11px;
            text-transform: uppercase;
        }
        .airlines-table td {
            padding: 4px 8px;
            border-bottom: 1px solid #C0C0C0;
            color: #000000;
            font-size: 11px;
        }
        .airlines-table tbody tr {
            background: white;
        }
        .airlines-table tbody tr:hover {
            background: #316AC5;
            color: white;
        }
        .airlines-table tbody tr:last-child td {
            border-bottom: none;
        }
        .airline-logo {
            max-width: 80px;
            max-height: 40px;
            object-fit: contain;
            border: 2px inset #C0C0C0;
            padding: 2px;
            background: white;
        }
        .airline-actions {
            display: flex;
            gap: 4px;
        }
        .btn-edit, .btn-delete {
            flex: 1;
            padding: 2px 12px;
            border: 2px outset #C0C0C0;
            font-size: 11px;
            font-weight: normal;
            cursor: pointer;
            font-family: 'MS Sans Serif', Arial, sans-serif;
        }
        .btn-edit {
            background: #C0C0C0;
            color: #000000;
        }
        .btn-edit:hover {
            background: #E8E8E8;
        }
        .btn-edit:active {
            border: 2px inset #C0C0C0;
            background: #808080;
        }
        .btn-delete {
            background: #C0C0C0;
            color: #000000;
        }
        .btn-delete:hover {
            background: #E8E8E8;
        }
        .btn-delete:active {
            border: 2px inset #C0C0C0;
            background: #808080;
        }
        .empty-state {
            text-align: center;
            padding: 20px;
            color: #000000;
        }
        .empty-state h3 {
            margin-bottom: 4px;
            color: #000000;
            font-size: 12px;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background: #C0C0C0;
            padding: 8px;
            border: 2px outset #C0C0C0;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }
        .modal-header {
            margin-bottom: 8px;
            background: linear-gradient(to bottom, #000080 0%, #000080 100%);
            color: white;
            padding: 4px 8px;
            border-bottom: 2px solid #000000;
            margin: -8px -8px 8px -8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .modal-header h2 {
            margin: 0;
            color: white;
            font-size: 12px;
            font-weight: bold;
            font-family: 'MS Sans Serif', Arial, sans-serif;
        }
        .modal-close {
            background: #C0C0C0;
            border: 2px outset #C0C0C0;
            font-size: 12px;
            color: #000000;
            cursor: pointer;
            padding: 2px 6px;
            width: 20px;
            height: 20px;
            line-height: 16px;
            font-family: 'MS Sans Serif', Arial, sans-serif;
        }
        .modal-close:hover {
            background: #E8E8E8;
        }
        .modal-close:active {
            border: 2px inset #C0C0C0;
            background: #808080;
        }
        .modal-body {
            padding: 8px;
            background: #C0C0C0;
        }
        .form-group {
            margin-bottom: 8px;
            padding: 4px;
        }
        .form-group label {
            display: block;
            margin-bottom: 2px;
            font-weight: bold;
            color: #000000;
            font-size: 11px;
        }
        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 2px 4px;
            border: 2px inset #C0C0C0;
            font-size: 11px;
            font-family: 'MS Sans Serif', Arial, sans-serif;
            background: white;
            box-sizing: border-box;
        }
        .form-group textarea {
            resize: vertical;
            min-height: 60px;
        }
        .form-group input:focus,
        .form-group textarea:focus {
            outline: 1px dotted #000000;
            outline-offset: -3px;
        }
        .form-group small {
            display: block;
            margin-top: 2px;
            color: #000000;
            font-size: 10px;
        }
        .modal-actions {
            display: flex;
            gap: 4px;
            justify-content: flex-end;
            margin-top: 8px;
            padding: 8px;
            border-top: 2px inset #C0C0C0;
        }
        .btn-primary, .btn-secondary {
            padding: 4px 16px;
            border: 2px outset #C0C0C0;
            cursor: pointer;
            font-size: 11px;
            font-weight: normal;
            font-family: 'MS Sans Serif', Arial, sans-serif;
        }
        .btn-primary {
            background: #C0C0C0;
            color: #000000;
        }
        .btn-primary:hover {
            background: #E8E8E8;
        }
        .btn-primary:active {
            border: 2px inset #C0C0C0;
            background: #808080;
        }
        .btn-secondary {
            background: #C0C0C0;
            color: #000000;
        }
        .btn-secondary:hover {
            background: #E8E8E8;
        }
        .btn-secondary:active {
            border: 2px inset #C0C0C0;
            background: #808080;
        }
    </style>
</head>
<body>
    <div class="airlines-container">
        <div class="airlines-header">
            <h1>✈️ Airlines Management</h1>
            <p>Manage airline profiles and logos</p>
        </div>
        
        <div class="airlines-content">
            <div class="airlines-actions">
                <h2>Airline Profiles</h2>
                <button class="btn-add" id="addAirlineBtn" onclick="openAirlineModal(null)" style="display: none;">+ Add Airline</button>
            </div>
            <div id="airlines-list" class="airlines-list">
                <!-- Airlines will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Airline Management Modal -->
    <div id="airlineModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Add Airline</h2>
                <button type="button" class="modal-close" id="closeAirlineModal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="airlineForm">
                    <input type="hidden" id="airlineId" value="">
                    
                    <div class="form-group">
                        <label for="airlineCompanyName">Company Name *</label>
                        <input type="text" id="airlineCompanyName" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="airlineName">Contact Name</label>
                        <input type="text" id="airlineName">
                    </div>
                    
                    <div class="form-group">
                        <label for="airlineEmail">Email</label>
                        <input type="email" id="airlineEmail">
                    </div>
                    
                    <div class="form-group">
                        <label for="airlinePhone">Phone Number</label>
                        <input type="tel" id="airlinePhone">
                    </div>
                    
                    <div class="form-group">
                        <label for="airlineAddress">Address</label>
                        <textarea id="airlineAddress" rows="3"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="airlineFormattedValue">Formatted Field Value</label>
                        <textarea id="airlineFormattedValue" rows="4" placeholder="This will be used to fill the form field. Format: Company Name\nContact Name\nEmail\nPhone\nAddress"></textarea>
                        <small>This value will be used to fill the form field. Use line breaks (\n) to format.</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="airlineAWBP">AWBP (01. AWBP)</label>
                        <input type="text" id="airlineAWBP" placeholder="Enter AWBP (Air Waybill Prefix)">
                        <small>This will be used to auto-fill field 01. AWBP when this airline is selected.</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="airlineAbbreviation">Airline Abbreviation</label>
                        <input type="text" id="airlineAbbreviation" placeholder="Enter Airline Abbreviation">
                        <small>This abbreviation will be stored with the airline contact.</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="airlineImage">Airline Logo/Image</label>
                        <input type="file" id="airlineImage" accept="image/*">
                        <small>Upload an image/logo for this airline (JPG, PNG, etc.)</small>
                        <div id="airlineImagePreview" style="margin-top: 10px; display: none;">
                            <img id="airlineImagePreviewImg" src="" alt="Preview" style="max-width: 200px; max-height: 100px; border: 1px solid #ddd; border-radius: 4px; padding: 5px;">
                            <button type="button" id="removeAirlineImageBtn" style="margin-left: 10px; padding: 5px 10px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer;">Remove Image</button>
                        </div>
                    </div>
                    
                    <div class="modal-actions">
                        <button type="button" class="btn-secondary" id="cancelAirlineBtn">Cancel</button>
                        <button type="submit" class="btn-primary" id="saveAirlineBtn">Save Airline</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script type="module" src="js/auth.js"></script>
    <script type="module">
        import { airlinesAPI } from './js/api.js';
        
        // Check if user is admin
        function isAdmin() {
            const user = getCurrentUser();
            return user && user.role === 'admin';
        }

        // Load airlines from API
        async function loadAirlines() {
            try {
                const airlines = await airlinesAPI.getAll();
                
                // Sort airlines alphabetically by company name
                airlines.sort((a, b) => {
                    const nameA = (a.companyName || '').toLowerCase();
                    const nameB = (b.companyName || '').toLowerCase();
                    return nameA.localeCompare(nameB);
                });
                
                const airlinesList = document.getElementById('airlines-list');
                if (airlines.length === 0) {
                    airlinesList.innerHTML = '<div class="empty-state"><h3>No Airlines</h3><p>Click "+ Add Airline" to create your first airline profile.</p></div>';
                } else {
                    airlinesList.innerHTML = createAirlinesTable(airlines);
                }
            } catch (error) {
                console.error('Error loading airlines:', error);
                const airlinesList = document.getElementById('airlines-list');
                airlinesList.innerHTML = '<div class="empty-state"><h3>Error Loading Airlines</h3><p>Please refresh the page or check your connection.</p></div>';
            }
        }

        function createAirlinesTable(airlines) {
            const isUserAdmin = isAdmin();
            let tableHTML = `
                <table class="airlines-table">
                    <thead>
                        <tr>
                            <th>Logo</th>
                            <th>Company Name</th>
                            <th>Abbreviation</th>
                            <th>AWBP</th>
                            ${isUserAdmin ? '<th>Actions</th>' : ''}
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            airlines.forEach(airline => {
                const hasImage = airline.image;
                tableHTML += `
                    <tr>
                        <td>
                            ${hasImage ? `<img src="${airline.image}" alt="${escapeHtml(airline.companyName)}" class="airline-logo">` : '<span style="color: #999;">No logo</span>'}
                        </td>
                        <td>
                            <strong>${escapeHtml(airline.companyName)}</strong>
                        </td>
                        <td>
                            ${airline.airlineAbbreviation ? `<span>${escapeHtml(airline.airlineAbbreviation)}</span>` : '<span style="color: #999;">-</span>'}
                        </td>
                        <td>
                            ${airline.awbp ? `<span>${escapeHtml(airline.awbp)}</span>` : '<span style="color: #999;">-</span>'}
                        </td>
                        ${isUserAdmin ? `
                        <td>
                            <div class="airline-actions">
                                <button class="btn-edit" onclick="openAirlineModal('${airline.id}')">Edit</button>
                                <button class="btn-delete" onclick="deleteAirline('${airline.id}')">Delete</button>
                            </div>
                        </td>
                        ` : ''}
                    </tr>
                `;
            });
            
            tableHTML += `
                    </tbody>
                </table>
            `;
            
            return tableHTML;
        }

        async function deleteAirline(airlineId) {
            // Check if user is admin
            if (!isAdmin()) {
                alert('Only administrators can delete airlines.');
                return;
            }
            
            if (!confirm('Are you sure you want to delete this airline?')) {
                return;
            }
            
            try {
                await airlinesAPI.delete(airlineId);
                alert('Airline deleted successfully!');
                await loadAirlines();
            } catch (error) {
                console.error('Error deleting airline:', error);
                alert('Error deleting airline. Please try again.');
            }
        }

        async function openAirlineModal(airlineIdToEdit) {
            // Check if user is admin
            if (!isAdmin()) {
                alert('Only administrators can add or edit airlines.');
                return;
            }
            
            const modal = document.getElementById('airlineModal');
            const form = document.getElementById('airlineForm');
            const airlineId = document.getElementById('airlineId');
            const modalTitle = document.getElementById('modalTitle');
            
            airlineId.value = airlineIdToEdit || '';
            
            if (airlineIdToEdit) {
                try {
                    const airlines = await airlinesAPI.getAll();
                    const airline = airlines.find(a => a.id === airlineIdToEdit);
                    if (airline) {
                        modalTitle.textContent = 'Edit Airline';
                        document.getElementById('airlineCompanyName').value = airline.companyName || '';
                        document.getElementById('airlineName').value = airline.contactName || '';
                        document.getElementById('airlineEmail').value = airline.email || '';
                        document.getElementById('airlinePhone').value = airline.phone || '';
                        document.getElementById('airlineAddress').value = airline.address || '';
                        document.getElementById('airlineFormattedValue').value = airline.formattedValue || '';
                        document.getElementById('airlineAWBP').value = airline.awbp || '';
                        document.getElementById('airlineAbbreviation').value = airline.airlineAbbreviation || '';
                        
                        // Load airline image if it exists
                        const airlineImagePreview = document.getElementById('airlineImagePreview');
                        const airlineImagePreviewImg = document.getElementById('airlineImagePreviewImg');
                        if (airline.image && airlineImagePreview && airlineImagePreviewImg) {
                            airlineImagePreviewImg.src = airline.image;
                            airlineImagePreview.style.display = 'block';
                        } else if (airlineImagePreview) {
                            airlineImagePreview.style.display = 'none';
                        }
                        
                        const airlineImageInput = document.getElementById('airlineImage');
                        if (airlineImageInput) {
                            airlineImageInput.value = ''; // Clear file input
                        }
                    }
                } catch (error) {
                    console.error('Error loading airline:', error);
                    alert('Error loading airline data.');
                }
            } else {
                modalTitle.textContent = 'Add Airline';
                form.reset();
                airlineId.value = '';
                const airlineImagePreview = document.getElementById('airlineImagePreview');
                if (airlineImagePreview) {
                    airlineImagePreview.style.display = 'none';
                }
            }
            
            modal.style.display = 'flex';
        }

        function closeAirlineModal() {
            const modal = document.getElementById('airlineModal');
            const form = document.getElementById('airlineForm');
            const airlineImagePreview = document.getElementById('airlineImagePreview');
            
            modal.style.display = 'none';
            form.reset();
            if (airlineImagePreview) {
                airlineImagePreview.style.display = 'none';
            }
        }

        async function handleSaveAirline(e) {
            e.preventDefault();
            
            const id = document.getElementById('airlineId').value || `airline_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
            const companyName = document.getElementById('airlineCompanyName').value.trim();
            const contactNameValue = document.getElementById('airlineName').value.trim();
            const email = document.getElementById('airlineEmail').value.trim();
            const phone = document.getElementById('airlinePhone').value.trim();
            const address = document.getElementById('airlineAddress').value.trim();
            const formattedValue = document.getElementById('airlineFormattedValue').value.trim();
            const awbp = document.getElementById('airlineAWBP').value.trim();
            const airlineAbbreviation = document.getElementById('airlineAbbreviation').value.trim();
            
            if (!companyName) {
                alert('Company Name is required.');
                return;
            }
            
            const airline = {
                id,
                type: 'Airline',
                companyName
            };
            
            // Add optional fields
            if (contactNameValue) airline.contactName = contactNameValue;
            if (email) airline.email = email;
            if (phone) airline.phone = phone;
            if (address) airline.address = address;
            if (formattedValue) airline.formattedValue = formattedValue;
            if (awbp) airline.awbp = awbp;
            if (airlineAbbreviation) airline.airlineAbbreviation = airlineAbbreviation;
            
            // Handle image upload
            const airlineImageInput = document.getElementById('airlineImage');
            const airlineImagePreviewImg = document.getElementById('airlineImagePreviewImg');
            if (airlineImageInput && airlineImageInput.files && airlineImageInput.files[0]) {
                // New image uploaded
                const file = airlineImageInput.files[0];
                const reader = new FileReader();
                reader.onload = async function(e) {
                    airline.image = e.target.result; // Store as base64
                    await saveAirlineToAPI(airline);
                };
                reader.readAsDataURL(file);
                return; // Exit early, save will happen in reader.onload
            } else if (airlineImagePreviewImg && airlineImagePreviewImg.src && airlineImagePreviewImg.src.startsWith('data:')) {
                // Existing image (not removed)
                airline.image = airlineImagePreviewImg.src;
            }
            // If image was removed (preview hidden), don't include image property
            
            await saveAirlineToAPI(airline);
        }
        
        async function saveAirlineToAPI(airline) {
            try {
                if (airline.id && airline.id.startsWith('airline_')) {
                    // Check if airline exists
                    const airlines = await airlinesAPI.getAll();
                    const exists = airlines.find(a => a.id === airline.id);
                    
                    if (exists) {
                        await airlinesAPI.update(airline);
                    } else {
                        await airlinesAPI.create(airline);
                    }
                } else {
                    // New airline
                    await airlinesAPI.create(airline);
                }
                
                closeAirlineModal();
                alert('✓ Airline saved successfully!');
                await loadAirlines();
            } catch (error) {
                console.error('Error saving airline:', error);
                alert('Error saving airline. Please try again.');
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Image upload preview functionality
        const airlineImageInput = document.getElementById('airlineImage');
        const airlineImagePreview = document.getElementById('airlineImagePreview');
        const airlineImagePreviewImg = document.getElementById('airlineImagePreviewImg');
        const removeAirlineImageBtn = document.getElementById('removeAirlineImageBtn');
        
        if (airlineImageInput) {
            airlineImageInput.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        airlineImagePreviewImg.src = e.target.result;
                        airlineImagePreview.style.display = 'block';
                    };
                    reader.readAsDataURL(file);
                } else {
                    airlineImagePreview.style.display = 'none';
                }
            });
        }
        
        if (removeAirlineImageBtn) {
            removeAirlineImageBtn.addEventListener('click', function() {
                if (airlineImageInput) {
                    airlineImageInput.value = '';
                }
                if (airlineImagePreviewImg) {
                    airlineImagePreviewImg.src = '';
                }
                if (airlineImagePreview) {
                    airlineImagePreview.style.display = 'none';
                }
            });
        }
        
        // Modal event handlers
        document.getElementById('airlineForm').addEventListener('submit', handleSaveAirline);
        document.getElementById('closeAirlineModal').addEventListener('click', closeAirlineModal);
        document.getElementById('cancelAirlineBtn').addEventListener('click', closeAirlineModal);
        
        document.getElementById('airlineModal').addEventListener('click', (e) => {
            if (e.target === document.getElementById('airlineModal')) {
                closeAirlineModal();
            }
        });

        // Load airlines on page load and set admin permissions
        async function initializePage() {
            await loadAirlines();
            
            // Show/hide add button based on admin status
            const isUserAdmin = isAdmin();
            const addBtn = document.getElementById('addAirlineBtn');
            if (addBtn) {
                addBtn.style.display = isUserAdmin ? 'block' : 'none';
            }
        }
        
        // Make functions available globally for onclick handlers
        window.deleteAirline = deleteAirline;
        window.openAirlineModal = openAirlineModal;
        window.closeAirlineModal = closeAirlineModal;
        window.handleSaveAirline = handleSaveAirline;
        
        // Initialize on page load
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializePage);
        } else {
            initializePage();
        }
    </script>
</body>
</html>
