<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Airlines - Airway Bills</title>
    <link rel="stylesheet" href="styles.css">
    <script type="module" src="js/themes.js"></script>
    <script src="js/roles.js"></script>
    <style>
        body {
            margin: 0;
            padding: 2px;
            font-family: 'MS Sans Serif', 'Arial', sans-serif;
            background: #008080;
            background-image: 
                repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(0,0,0,0.02) 2px, rgba(0,0,0,0.02) 4px);
            min-height: 100vh;
        }
        .airlines-container {
            max-width: 1200px;
            margin: 0 auto;
            background: #C0C0C0;
            border: 2px outset #C0C0C0;
            overflow: hidden;
        }
        .airlines-header {
            background: linear-gradient(to bottom, #000080 0%, #000080 100%);
            color: white;
            padding: 4px 8px;
            text-align: center;
            border-bottom: 2px solid #000000;
        }
        .airlines-header h1 {
            font-size: 16px;
            margin-bottom: 2px;
            font-weight: bold;
            font-family: 'MS Sans Serif', Arial, sans-serif;
        }
        .airlines-content {
            padding: 8px;
        }
        .airlines-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        .btn-add {
            padding: 4px 16px;
            background: #D4D4D4;
            color: #000000;
            border: 2px solid #808080;
            font-size: 11px;
            font-weight: bold;
            cursor: pointer;
            font-family: 'MS Sans Serif', Arial, sans-serif;
        }
        .btn-add:hover {
            background: #E8E8E8;
        }
        .btn-add:active {
            border: 2px solid #606060;
            background: #B0B0B0;
        }
        .airlines-list {
            background: white;
            overflow: hidden;
            border: 2px inset #C0C0C0;
        }
        .airlines-table {
            width: 100%;
            border-collapse: collapse;
        }
        .airlines-table thead {
            background: #C0C0C0;
            border-bottom: 2px inset #C0C0C0;
        }
        .airlines-table th {
            padding: 4px 8px;
            text-align: left;
            font-weight: bold;
            color: #000000;
            font-size: 11px;
            text-transform: uppercase;
            border-right: 1px solid #808080;
        }
        .airlines-table th:last-child {
            border-right: none;
        }
        .airlines-table td {
            padding: 4px 8px;
            border-bottom: 1px solid #C0C0C0;
            border-right: 1px solid #C0C0C0;
            color: #000000;
            font-size: 11px;
        }
        .airlines-table td:last-child {
            border-right: none;
        }
        .airlines-table tbody tr {
            background: white;
        }
        .airlines-table tbody tr:hover {
            background: #316AC5;
            color: white;
        }
        .airlines-table tbody tr:last-child td {
            border-bottom: none;
        }
        .airline-logo {
            max-width: 80px;
            max-height: 40px;
            object-fit: contain;
            border: 2px inset #C0C0C0;
            padding: 2px;
            background: white;
        }
        .airline-actions {
            display: flex;
            gap: 4px;
        }
        .btn-edit, .btn-delete {
            flex: 1;
            padding: 2px 12px;
            border: 2px solid #808080;
            font-size: 11px;
            font-weight: bold;
            cursor: pointer;
            font-family: 'MS Sans Serif', Arial, sans-serif;
        }
        .btn-edit {
            background: #D4D4D4;
            color: #000000;
        }
        .btn-edit:hover {
            background: #E8E8E8;
        }
        .btn-edit:active {
            border: 2px solid #606060;
            background: #B0B0B0;
        }
        .btn-delete {
            background: #D4D4D4;
            color: #000000;
        }
        .btn-delete:hover {
            background: #E8E8E8;
        }
        .btn-delete:active {
            border: 2px solid #606060;
            background: #B0B0B0;
        }
        .empty-state {
            text-align: center;
            padding: 20px;
            color: #000000;
        }
        .empty-state h3 {
            margin-bottom: 4px;
            color: #000000;
            font-size: 12px;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background: #C0C0C0;
            padding: 8px;
            border: 2px outset #C0C0C0;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }
        .modal-header {
            margin-bottom: 8px;
            background: linear-gradient(to bottom, #000080 0%, #000080 100%);
            color: white;
            padding: 4px 8px;
            border-bottom: 2px solid #000000;
            margin: -8px -8px 8px -8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .modal-header h2 {
            margin: 0;
            color: white;
            font-size: 12px;
            font-weight: bold;
            font-family: 'MS Sans Serif', Arial, sans-serif;
        }
        .modal-close {
            background: #C0C0C0;
            border: 2px outset #C0C0C0;
            font-size: 12px;
            color: #000000;
            cursor: pointer;
            padding: 2px 6px;
            width: 20px;
            height: 20px;
            line-height: 16px;
            font-family: 'MS Sans Serif', Arial, sans-serif;
        }
        .modal-close:hover {
            background: #E8E8E8;
        }
        .modal-close:active {
            border: 2px inset #C0C0C0;
            background: #808080;
        }
        .modal-body {
            padding: 8px;
            background: #C0C0C0;
        }
        .form-group {
            margin-bottom: 8px;
            padding: 4px;
        }
        .form-group label {
            display: block;
            margin-bottom: 2px;
            font-weight: bold;
            color: #000000;
            font-size: 11px;
        }
        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 2px 4px;
            border: 2px inset #C0C0C0;
            font-size: 11px;
            font-family: 'MS Sans Serif', Arial, sans-serif;
            background: white;
            box-sizing: border-box;
        }
        .form-group textarea {
            resize: vertical;
            min-height: 60px;
        }
        .form-group input:focus,
        .form-group textarea:focus {
            outline: 1px dotted #000000;
            outline-offset: -3px;
        }
        .form-group small {
            display: block;
            margin-top: 2px;
            color: #000000;
            font-size: 10px;
        }
        .modal-actions {
            display: flex;
            gap: 4px;
            justify-content: flex-end;
            margin-top: 8px;
            padding: 8px;
            border-top: 2px inset #C0C0C0;
        }
        .btn-primary, .btn-secondary {
            padding: 4px 16px;
            border: 2px outset #C0C0C0;
            cursor: pointer;
            font-size: 11px;
            font-weight: normal;
            font-family: 'MS Sans Serif', Arial, sans-serif;
        }
        .btn-primary {
            background: #C0C0C0;
            color: #000000;
        }
        .btn-primary:hover {
            background: #E8E8E8;
        }
        .btn-primary:active {
            border: 2px inset #C0C0C0;
            background: #808080;
        }
        .btn-secondary {
            background: #C0C0C0;
            color: #000000;
        }
        .btn-secondary:hover {
            background: #E8E8E8;
        }
        .btn-secondary:active {
            border: 2px inset #C0C0C0;
            background: #808080;
        }
    </style>
</head>
<body>
    <div class="airlines-container">
        <div class="airlines-header">
            <h1>‚úàÔ∏è Airlines Management</h1>
            <p>Manage airline profiles and logos</p>
        </div>
        
        <div class="airlines-content">
            <div class="airlines-actions">
                <h2>Airline Profiles</h2>
                <button class="btn-add" id="addAirlineBtn" style="display: block; visibility: visible;">+ Add Airline</button>
            </div>
            <div id="airlines-list" class="airlines-list">
                <!-- Airlines will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Airline Management Modal -->
    <div id="airlineModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Add Airline</h2>
                <button type="button" class="modal-close" id="closeAirlineModal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="airlineForm">
                    <input type="hidden" id="airlineId" value="">
                    
                    <div class="form-group">
                        <label for="airlineCompanyName">Company Name *</label>
                        <input type="text" id="airlineCompanyName" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="airlineName">Contact Name</label>
                        <input type="text" id="airlineName">
                    </div>
                    
                    <div class="form-group">
                        <label for="airlineEmail">Email</label>
                        <input type="email" id="airlineEmail">
                    </div>
                    
                    <div class="form-group">
                        <label for="airlinePhone">Phone Number</label>
                        <input type="tel" id="airlinePhone">
                    </div>
                    
                    <div class="form-group">
                        <label for="airlineAddress">Address <span style="background: #e0e0e0; padding: 2px 6px; border-radius: 3px; font-size: 10px; font-weight: normal; margin-left: 5px;">Field 98</span></label>
                        <textarea id="airlineAddress" rows="3"></textarea>
                        <small>This will be used to auto-fill field 98 when this airline is selected.</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="airlineFormattedValue">Formatted Field Value</label>
                        <textarea id="airlineFormattedValue" rows="4" placeholder="This will be used to fill the form field. Format: Company Name\nContact Name\nEmail\nPhone\nAddress"></textarea>
                        <small>This value will be used to fill the form field. Use line breaks (\n) to format.</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="airlineAWBP">AWBP <span style="background: #e0e0e0; padding: 2px 6px; border-radius: 3px; font-size: 10px; font-weight: normal; margin-left: 5px;">Field 01</span></label>
                        <input type="text" id="airlineAWBP" placeholder="Enter AWBP (Air Waybill Prefix)">
                        <small>This will be used to auto-fill field 01. AWBP when this airline is selected.</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="airlineAbbreviation">Airline Abbreviation <span style="background: #e0e0e0; padding: 2px 6px; border-radius: 3px; font-size: 10px; font-weight: normal; margin-left: 5px;">Field 10</span></label>
                        <input type="text" id="airlineAbbreviation" placeholder="Enter Airline Abbreviation">
                        <small>This will be used to auto-fill field 10 when this airline is selected.</small>
                        <small>This abbreviation will be stored with the airline contact.</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="airlineImage">Airline Logo/Image <span style="background: #e0e0e0; padding: 2px 6px; border-radius: 3px; font-size: 10px; font-weight: normal; margin-left: 5px;">Field 99</span></label>
                        <input type="file" id="airlineImage" accept="image/*">
                        <small>This will be used to auto-fill field 99 when this airline is selected. Upload an image/logo for this airline (JPG, PNG, etc.)</small>
                        <div id="airlineImagePreview" style="margin-top: 10px; display: none;">
                            <img id="airlineImagePreviewImg" src="" alt="Preview" style="max-width: 200px; max-height: 100px; border: 1px solid #ddd; border-radius: 4px; padding: 5px;">
                            <button type="button" id="removeAirlineImageBtn" style="margin-left: 10px; padding: 5px 10px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer;">Remove Image</button>
                        </div>
                    </div>
                    
                    <div class="modal-actions">
                        <button type="button" class="btn-secondary" id="cancelAirlineBtn">Cancel</button>
                        <button type="submit" class="btn-primary" id="saveAirlineBtn">Save Airline</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script type="module" src="js/auth.js"></script>
    <script type="module">
        import { airlinesAPI } from './js/api.js';
        
        // Function to get image dimensions
        function getImageDimensions(imageDataUrl) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.onload = function() {
                    resolve({ width: img.width, height: img.height });
                };
                img.onerror = function() {
                    reject(new Error('Failed to load image'));
                };
                img.src = imageDataUrl;
            });
        }
        
        // Function to check Avianca logo dimensions (for reference)
        async function checkAviancaLogoSize() {
            try {
                const airlines = await airlinesAPI.getAll();
                const avianca = airlines.find(a => 
                    a.companyName && (
                        a.companyName.toLowerCase().includes('avianca') ||
                        a.companyName.toLowerCase().includes('avianca cargo')
                    )
                );
                if (avianca && avianca.image) {
                    const dimensions = await getImageDimensions(avianca.image);
                    console.log('üìè Avianca Cargo logo dimensions:', dimensions);
                    return dimensions;
                } else {
                    console.log('‚ÑπÔ∏è Avianca Cargo logo not found in database');
                    return null;
                }
            } catch (error) {
                console.error('Error checking Avianca logo:', error);
                return null;
            }
        }
        
        // Function to resize image to standard dimensions (matching Avianca Cargo logo size)
        // Standard size: 268px width √ó 55px height (exact Avianca dimensions)
        function resizeAirlineLogo(imageDataUrl, targetWidth = 268, targetHeight = 55) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    
                    // Use exact dimensions to match Avianca logo
                    const newWidth = targetWidth;
                    const newHeight = targetHeight;
                    
                    canvas.width = newWidth;
                    canvas.height = newHeight;
                    
                    // Draw and resize image to exact dimensions (may stretch/squash to fit)
                    ctx.drawImage(img, 0, 0, newWidth, newHeight);
                    
                    // Convert to data URL
                    const resizedDataUrl = canvas.toDataURL('image/png', 0.95);
                    console.log(`‚úì Logo resized from ${img.width}x${img.height} to ${newWidth}x${newHeight} (Avianca standard)`);
                    resolve(resizedDataUrl);
                };
                img.onerror = function() {
                    reject(new Error('Failed to load image for resizing'));
                };
                img.src = imageDataUrl;
            });
        }
        
        // Check if user is admin
        function isAdmin() {
            const user = getCurrentUser();
            return user && user.role === 'admin';
        }
        
        // Check if user can manage locations based on permissions
        function canManageLocations() {
            const user = getCurrentUser();
            if (!user) return false;
            
            // Check permission using hasPermission if available
            if (typeof hasPermission === 'function') {
                return hasPermission(user.role, 'canEditLocations');
            }
            
            // Fallback: admin and issuing-carrier-agent (TEMPORARY for development)
            return user.role === 'admin' || user.role === 'issuing-carrier-agent';
        }

        // Load airlines from API
        async function loadAirlines() {
            try {
                const airlines = await airlinesAPI.getAll();
                
                // Check Avianca logo size on first load (for reference)
                if (airlines.length > 0) {
                    checkAviancaLogoSize();
                }
                
                // Sort airlines alphabetically by company name
                airlines.sort((a, b) => {
                    const nameA = (a.companyName || '').toLowerCase();
                    const nameB = (b.companyName || '').toLowerCase();
                    return nameA.localeCompare(nameB);
                });
                
                const airlinesList = document.getElementById('airlines-list');
                if (airlines.length === 0) {
                    airlinesList.innerHTML = '<div class="empty-state"><h3>No Airlines</h3><p>Click "+ Add Airline" to create your first airline profile.</p></div>';
                } else {
                    airlinesList.innerHTML = createAirlinesTable(airlines);
                }
            } catch (error) {
                console.error('Error loading airlines:', error);
                const airlinesList = document.getElementById('airlines-list');
                airlinesList.innerHTML = '<div class="empty-state"><h3>Error Loading Airlines</h3><p>Please refresh the page or check your connection.</p></div>';
            }
        }

        function createAirlinesTable(airlines) {
            // TEMPORARY: Allow issuing carrier agents during development
            const canManage = canManageLocations();
            let tableHTML = `
                <table class="airlines-table">
                    <thead>
                        <tr>
                            <th>Logo</th>
                            <th>Company Name</th>
                            <th>Abbreviation</th>
                            <th>AWBP</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            airlines.forEach(airline => {
                const hasImage = airline.image;
                tableHTML += `
                    <tr>
                        <td>
                            ${hasImage ? `<img src="${airline.image}" alt="${escapeHtml(airline.companyName)}" class="airline-logo">` : '<span style="color: #999;">No logo</span>'}
                        </td>
                        <td>
                            <strong>${escapeHtml(airline.companyName)}</strong>
                        </td>
                        <td>
                            ${airline.airlineAbbreviation ? `<span>${escapeHtml(airline.airlineAbbreviation)}</span>` : '<span style="color: #999;">-</span>'}
                        </td>
                        <td>
                            ${airline.awbp ? `<span>${escapeHtml(airline.awbp)}</span>` : '<span style="color: #999;">-</span>'}
                        </td>
                        <td>
                            <div class="airline-actions">
                                <button class="btn-edit" onclick="openAirlineModal('${airline.id}')">Edit</button>
                                ${canManage ? `<button class="btn-delete" onclick="deleteAirline('${airline.id}')">Delete</button>` : ''}
                            </div>
                        </td>
                    </tr>
                `;
            });
            
            tableHTML += `
                    </tbody>
                </table>
            `;
            
            return tableHTML;
        }

        async function deleteAirline(airlineId) {
            // Check if user is admin
            // TEMPORARY: Allow issuing carrier agents during development
            if (!canManageLocations()) {
                alert('Only administrators and issuing carrier agents can delete airlines.');
                return;
            }
            
            if (!confirm('Are you sure you want to delete this airline?')) {
                return;
            }
            
            try {
                await airlinesAPI.delete(airlineId);
                alert('Airline deleted successfully!');
                await loadAirlines();
            } catch (error) {
                console.error('Error deleting airline:', error);
                alert('Error deleting airline. Please try again.');
            }
        }

        async function openAirlineModal(airlineIdToEdit) {
            console.log('üñ±Ô∏è openAirlineModal called with airlineIdToEdit:', airlineIdToEdit);
            
            // Only check admin for adding new airlines
            if (!airlineIdToEdit) {
                try {
                    const user = getCurrentUser();
                    // TEMPORARY: Allow issuing carrier agents during development
                    const canManage = user && (user.role === 'admin' || user.role === 'issuing-carrier-agent');
                    if (!canManage) {
                        alert('Only administrators and issuing carrier agents can add new airlines.');
                        console.log('‚úó Add blocked - user cannot manage locations');
                        return;
                    }
                    console.log('‚úì Add allowed - user is admin');
                } catch (error) {
                    console.error('Error checking admin status:', error);
                    alert('Error checking permissions. Please try again.');
                    return;
                }
            }
            
            const modal = document.getElementById('airlineModal');
            const form = document.getElementById('airlineForm');
            const airlineId = document.getElementById('airlineId');
            const modalTitle = document.getElementById('modalTitle');
            
            airlineId.value = airlineIdToEdit || '';
            
            if (airlineIdToEdit) {
                try {
                    const airlines = await airlinesAPI.getAll();
                    const airline = airlines.find(a => a.id === airlineIdToEdit);
                    if (airline) {
                        modalTitle.textContent = 'Edit Airline';
                        document.getElementById('airlineCompanyName').value = airline.companyName || '';
                        document.getElementById('airlineName').value = airline.contactName || '';
                        document.getElementById('airlineEmail').value = airline.email || '';
                        document.getElementById('airlinePhone').value = airline.phone || '';
                        document.getElementById('airlineAddress').value = airline.address || '';
                        document.getElementById('airlineFormattedValue').value = airline.formattedValue || '';
                        document.getElementById('airlineAWBP').value = airline.awbp || '';
                        document.getElementById('airlineAbbreviation').value = airline.airlineAbbreviation || '';
                        
                        // Load airline image if it exists
                        const airlineImagePreview = document.getElementById('airlineImagePreview');
                        const airlineImagePreviewImg = document.getElementById('airlineImagePreviewImg');
                        if (airline.image && airlineImagePreview && airlineImagePreviewImg) {
                            // Clear any "removed" flag
                            airlineImagePreviewImg.removeAttribute('data-removed');
                            // Show the image (resizing will happen on save if needed)
                            airlineImagePreviewImg.src = airline.image;
                            airlineImagePreview.style.display = 'block';
                            console.log('‚úì Airline logo loaded in preview');
                        } else if (airlineImagePreview) {
                            airlineImagePreview.style.display = 'none';
                            if (airlineImagePreviewImg) {
                                airlineImagePreviewImg.src = '';
                                airlineImagePreviewImg.removeAttribute('data-removed');
                            }
                        }
                        
                        const airlineImageInput = document.getElementById('airlineImage');
                        if (airlineImageInput) {
                            airlineImageInput.value = ''; // Clear file input
                        }
                    }
                } catch (error) {
                    console.error('Error loading airline:', error);
                    alert('Error loading airline data.');
                }
            } else {
                modalTitle.textContent = 'Add Airline';
                form.reset();
                airlineId.value = '';
                const airlineImagePreview = document.getElementById('airlineImagePreview');
                if (airlineImagePreview) {
                    airlineImagePreview.style.display = 'none';
                }
            }
            
            modal.style.display = 'flex';
        }

        function closeAirlineModal() {
            const modal = document.getElementById('airlineModal');
            const form = document.getElementById('airlineForm');
            const airlineImagePreview = document.getElementById('airlineImagePreview');
            
            modal.style.display = 'none';
            form.reset();
            if (airlineImagePreview) {
                airlineImagePreview.style.display = 'none';
            }
        }

        async function handleSaveAirline(e) {
            e.preventDefault();
            
            const id = document.getElementById('airlineId').value || `airline_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
            const companyName = document.getElementById('airlineCompanyName').value.trim();
            const contactNameValue = document.getElementById('airlineName').value.trim();
            const email = document.getElementById('airlineEmail').value.trim();
            const phone = document.getElementById('airlinePhone').value.trim();
            const address = document.getElementById('airlineAddress').value.trim();
            const formattedValue = document.getElementById('airlineFormattedValue').value.trim();
            const awbp = document.getElementById('airlineAWBP').value.trim();
            const airlineAbbreviation = document.getElementById('airlineAbbreviation').value.trim();
            
            if (!companyName) {
                alert('Company Name is required.');
                return;
            }
            
            const airline = {
                id,
                type: 'Airline',
                companyName
            };
            
            // Add optional fields
            if (contactNameValue) airline.contactName = contactNameValue;
            if (email) airline.email = email;
            if (phone) airline.phone = phone;
            if (address) airline.address = address;
            if (formattedValue) airline.formattedValue = formattedValue;
            if (awbp) airline.awbp = awbp;
            if (airlineAbbreviation) airline.airlineAbbreviation = airlineAbbreviation;
            
            // Handle image upload/removal
            const airlineImageInput = document.getElementById('airlineImage');
            const airlineImagePreviewImg = document.getElementById('airlineImagePreviewImg');
            const airlineImagePreview = document.getElementById('airlineImagePreview');
            
            // Check if image was explicitly removed
            if (airlineImagePreviewImg && airlineImagePreviewImg.getAttribute('data-removed') === 'true') {
                // Image was removed - explicitly set to null to ensure it's deleted
                airline.image = null;
                airlineImagePreviewImg.removeAttribute('data-removed');
                console.log('‚úì Image removed from airline (set to null)');
                await saveAirlineToAPI(airline);
                return;
            }
            
            // Check if new image was uploaded
            if (airlineImageInput && airlineImageInput.files && airlineImageInput.files[0]) {
                // New image uploaded - resize it before saving
                const file = airlineImageInput.files[0];
                const reader = new FileReader();
                reader.onload = async function(e) {
                    try {
                        // Resize the image to standard dimensions before saving
                        console.log('Resizing uploaded logo...');
                        const resizedImage = await resizeAirlineLogo(e.target.result);
                        airline.image = resizedImage; // Store resized base64
                        console.log('‚úì Logo resized and ready to save');
                        await saveAirlineToAPI(airline);
                    } catch (error) {
                        console.error('Error resizing logo before save:', error);
                        // Fallback to original if resize fails
                        airline.image = e.target.result;
                        await saveAirlineToAPI(airline);
                    }
                };
                reader.readAsDataURL(file);
                return; // Exit early, save will happen in reader.onload
            }
            
            // Check if existing image needs resizing (only if preview is visible and has a valid image)
            if (airlineImagePreviewImg && 
                airlineImagePreviewImg.src && 
                airlineImagePreviewImg.src.startsWith('data:') &&
                airlineImagePreview && 
                airlineImagePreview.style.display !== 'none') {
                // Existing image - check if it needs resizing
                const existingImage = airlineImagePreviewImg.src;
                const img = new Image();
                img.onload = async function() {
                    // Always resize to ensure consistency, even if dimensions seem okay
                    try {
                        console.log(`Resizing existing logo from ${img.width}x${img.height}...`);
                        const resizedImage = await resizeAirlineLogo(existingImage);
                        airline.image = resizedImage;
                        console.log('‚úì Existing logo resized to standard size');
                        await saveAirlineToAPI(airline);
                    } catch (error) {
                        console.error('Error resizing existing logo:', error);
                        airline.image = existingImage;
                        await saveAirlineToAPI(airline);
                    }
                };
                img.onerror = function() {
                    console.warn('Could not load existing image for resizing, using as-is');
                    airline.image = existingImage;
                    saveAirlineToAPI(airline);
                };
                img.src = existingImage;
                return; // Exit early, save will happen in img.onload
            }
            
            // No image changes - save normally
            await saveAirlineToAPI(airline);
        }
        
        async function saveAirlineToAPI(airline) {
            try {
                if (airline.id && airline.id.startsWith('airline_')) {
                    // Check if airline exists
                    const airlines = await airlinesAPI.getAll();
                    const exists = airlines.find(a => a.id === airline.id);
                    
                    if (exists) {
                        // Editing existing airline - allowed for all users
                        await airlinesAPI.update(airline);
                    } else {
                        // Creating new airline - only admins
                        // TEMPORARY: Allow issuing carrier agents during development
                        if (!canManageLocations()) {
                            alert('Only administrators and issuing carrier agents can add new airlines.');
                            return;
                        }
                        await airlinesAPI.create(airline);
                    }
                } else {
                    // New airline - only admins
                    // TEMPORARY: Allow issuing carrier agents during development
                    if (!canManageLocations()) {
                        alert('Only administrators and issuing carrier agents can add new airlines.');
                        return;
                    }
                    await airlinesAPI.create(airline);
                }
                
                closeAirlineModal();
                alert('‚úì Airline saved successfully!');
                await loadAirlines();
            } catch (error) {
                console.error('Error saving airline:', error);
                alert('Error saving airline. Please try again.');
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Image upload preview functionality
        const airlineImageInput = document.getElementById('airlineImage');
        const airlineImagePreview = document.getElementById('airlineImagePreview');
        const airlineImagePreviewImg = document.getElementById('airlineImagePreviewImg');
        const removeAirlineImageBtn = document.getElementById('removeAirlineImageBtn');
        
        if (airlineImageInput) {
            airlineImageInput.addEventListener('change', async function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = async function(e) {
                        try {
                            // Resize the image to standard dimensions
                            const resizedImage = await resizeAirlineLogo(e.target.result);
                            airlineImagePreviewImg.src = resizedImage;
                            airlineImagePreview.style.display = 'block';
                            console.log('‚úì Logo preview updated with resized image');
                        } catch (error) {
                            console.error('Error resizing logo:', error);
                            // Fallback to original if resize fails
                            airlineImagePreviewImg.src = e.target.result;
                            airlineImagePreview.style.display = 'block';
                        }
                    };
                    reader.readAsDataURL(file);
                } else {
                    airlineImagePreview.style.display = 'none';
                }
            });
        }
        
        if (removeAirlineImageBtn) {
            removeAirlineImageBtn.addEventListener('click', function() {
                if (airlineImageInput) {
                    airlineImageInput.value = '';
                }
                if (airlineImagePreviewImg) {
                    airlineImagePreviewImg.src = '';
                    // Set a data attribute to mark image as removed
                    airlineImagePreviewImg.setAttribute('data-removed', 'true');
                }
                if (airlineImagePreview) {
                    airlineImagePreview.style.display = 'none';
                }
                console.log('‚úì Image marked for removal');
            });
        }
        
        // Modal event handlers
        document.getElementById('airlineForm').addEventListener('submit', handleSaveAirline);
        document.getElementById('closeAirlineModal').addEventListener('click', closeAirlineModal);
        document.getElementById('cancelAirlineBtn').addEventListener('click', closeAirlineModal);
        
        document.getElementById('airlineModal').addEventListener('click', (e) => {
            if (e.target === document.getElementById('airlineModal')) {
                closeAirlineModal();
            }
        });

        // Load airlines on page load and set admin permissions
        async function initializePage() {
            // Wait for auth to be ready - try multiple times
            let attempts = 0;
            while (typeof getCurrentUser === 'undefined' && attempts < 100) {
                await new Promise(resolve => setTimeout(resolve, 100));
                attempts++;
            }
            
            await loadAirlines();
            
            // Show/hide add button based on admin status - try multiple times
            const addBtn = document.getElementById('addAirlineBtn');
            if (!addBtn) {
                console.error('‚ùå Add Airline button not found in DOM!');
                return;
            }
            
            console.log('üîç Add Airline button found, checking admin status...');
            
            // Try checking user multiple times in case session loads asynchronously
            let user = null;
            for (let i = 0; i < 10; i++) {
                try {
                    if (typeof getCurrentUser === 'function') {
                        user = getCurrentUser();
                        if (user) {
                            console.log(`‚úì User found on attempt ${i + 1}:`, user.email, user.role);
                            break;
                        }
                    }
                } catch (error) {
                    console.warn(`Attempt ${i + 1} to get user failed:`, error);
                }
                if (i < 9) {
                    await new Promise(resolve => setTimeout(resolve, 200));
                }
            }
            
            // ALWAYS show button - admin check happens in openAirlineModal when clicked
            addBtn.style.display = 'block';
            addBtn.style.visibility = 'visible';
            addBtn.style.opacity = '1';
            console.log('‚úì Add Airline button is now visible (always shown)');
            
            if (!user) {
                console.warn('‚ö† No user logged in, but button is visible. Admin check will happen when clicked.');
            } else {
                // TEMPORARY: Allow issuing carrier agents during development
                const canManage = user && (user.role === 'admin' || user.role === 'issuing-carrier-agent');
                if (canManage) {
                    console.log('‚úì User can manage locations (admin or issuing-carrier-agent)');
                } else {
                    console.log('‚úó Non-admin user. User:', user.email, 'Role:', user.role);
                    console.log('  (Button still visible - admin check on click)');
                }
            }
            
            // Add click event listener for add button
            addBtn.addEventListener('click', () => {
                console.log('üñ±Ô∏è Add Airline button clicked');
                openAirlineModal(null);
            });
            
            console.log('‚úÖ Add Airline button setup complete');
        }
        
        // Make functions available globally for onclick handlers
        window.deleteAirline = deleteAirline;
        window.openAirlineModal = openAirlineModal;
        window.closeAirlineModal = closeAirlineModal;
        window.handleSaveAirline = handleSaveAirline;
        
        // Immediate check for button
        console.log('üîç Airlines page script loaded');
        setTimeout(() => {
            const immediateCheck = document.getElementById('addAirlineBtn');
            if (immediateCheck) {
                console.log('‚úÖ Add Airline button found in DOM');
                immediateCheck.style.display = 'block';
                immediateCheck.style.visibility = 'visible';
            } else {
                console.error('‚ùå Add Airline button NOT found in DOM');
            }
        }, 100);
        
        // Initialize on page load
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializePage);
        } else {
            initializePage();
        }
    </script>
</body>
</html>
