<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shipment Space - Airway Bills</title>
    <link rel="stylesheet" href="../styles.css">
    <script type="module" src="../js/themes.js"></script>
    <style>
        body {
            margin: 0;
            padding: 2px;
            font-family: 'MS Sans Serif', 'Arial', sans-serif;
            background: #008080;
            background-image: 
                repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(0,0,0,0.02) 2px, rgba(0,0,0,0.02) 4px);
            min-height: 100vh;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: #C0C0C0;
            padding: 8px;
            border: 2px outset #C0C0C0;
        }
        .space-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px inset #C0C0C0;
        }
        .space-header h1 {
            margin: 0;
            color: #000000;
            font-size: 16px;
            font-weight: bold;
            font-family: 'MS Sans Serif', Arial, sans-serif;
        }
        .space-id {
            font-size: 12px;
            color: #000000;
            margin: 5px 0;
            font-family: 'MS Sans Serif', Arial, sans-serif;
        }
        .awb-number {
            font-size: 16px;
            font-weight: bold;
            color: #000000;
            margin: 10px 0;
            font-family: 'MS Sans Serif', Arial, sans-serif;
        }
        .status-badge {
            padding: 4px 12px;
            border: 2px inset #C0C0C0;
            font-size: 11px;
            font-weight: normal;
            text-transform: uppercase;
            background: #C0C0C0;
            color: #000000;
            font-family: 'MS Sans Serif', Arial, sans-serif;
        }
        .status-active { background: #E0FFE0; color: #000000; }
        .status-cancelled { background: #FFE0E0; color: #000000; }
        .status-shared { background: #FFFFE0; color: #000000; }
        .status-pending { background: #FFFFE0; color: #000000; }
        .status-in-transit { background: #E0E0FF; color: #000000; }
        .action-buttons {
            margin-top: 20px;
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        .btn {
            padding: 4px 12px;
            border: 2px solid #808080;
            font-size: 11px;
            font-weight: bold;
            cursor: pointer;
            background: #D4D4D4;
            color: #000000;
            font-family: 'MS Sans Serif', Arial, sans-serif;
            white-space: nowrap;
        }
        .btn-primary {
            background: #C0C0C0;
            color: #000000;
        }
        .btn-success {
            background: #C0C0C0;
            color: #000000;
        }
        .btn-warning {
            background: #C0C0C0;
            color: #000000;
        }
        .btn-danger {
            background: #C0C0C0;
            color: #000000;
        }
        .btn-secondary {
            background: #C0C0C0;
            color: #000000;
        }
        .btn:hover {
            background: #E8E8E8;
        }
        .btn:active {
            border: 2px solid #606060;
            background: #B0B0B0;
        }
        .info-section {
            margin: 20px 0;
            padding: 8px;
            background: white;
            border: 2px inset #C0C0C0;
        }
        .info-section h2 {
            margin-top: 0;
            color: #000000;
            font-size: 14px;
            font-weight: bold;
            font-family: 'MS Sans Serif', Arial, sans-serif;
        }
        .participants-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 8px;
        }
        .participant-badge {
            background: #C0C0C0;
            color: #000000;
            padding: 4px 12px;
            border: 2px inset #C0C0C0;
            font-size: 11px;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-family: 'MS Sans Serif', Arial, sans-serif;
        }
        .participant-remove {
            background: #808080;
            border: 2px outset #C0C0C0;
            color: #000000;
            width: 18px;
            height: 18px;
            cursor: pointer;
            font-size: 12px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
            font-family: 'MS Sans Serif', Arial, sans-serif;
        }
        .participant-remove:hover {
            background: #A0A0A0;
        }
        .participant-remove:active {
            border: 2px inset #C0C0C0;
            background: #606060;
        }
        .pdf-section {
            margin: 20px 0;
            padding: 8px;
            background: white;
            border: 2px inset #C0C0C0;
        }
        .pdf-section h2 {
            margin-top: 0;
            color: #000000;
            font-size: 14px;
            font-weight: bold;
            font-family: 'MS Sans Serif', Arial, sans-serif;
        }
        .pdf-section p {
            color: #000000;
            font-size: 11px;
            font-family: 'MS Sans Serif', Arial, sans-serif;
        }
        .restricted-section {
            margin: 20px 0;
            padding: 8px;
            background: white;
            border: 2px inset #C0C0C0;
        }
        .restricted-section p {
            margin: 0;
            color: #000000;
            font-size: 11px;
            font-family: 'MS Sans Serif', Arial, sans-serif;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="space-header">
            <div>
                <h1>Shipment Space</h1>
                <div class="awb-number" id="awbDisplay" style="display: none;"></div>
                <div class="space-id" id="spaceIdDisplay">Loading...</div>
            </div>
            <div>
                <span class="status-badge" id="statusBadge">Loading...</span>
            </div>
        </div>

        <div id="agentSection" style="display: none;">
            <div class="action-buttons">
                <button class="btn btn-primary" id="createAWBBtn">Create AWB</button>
                <button class="btn btn-success" id="shareAWBBtn" style="display: none;">Share AWB with Participants</button>
                <button class="btn btn-warning" id="cancelBtn">Cancel Shipment</button>
                <button class="btn btn-danger" id="deleteBtn" style="display: none;">Delete Shipment</button>
            </div>
        </div>

        <div class="info-section">
            <h2>Participants</h2>
            <div class="participants-list" id="participantsList">Loading...</div>
        </div>

        <div id="pdfSection" class="pdf-section" style="display: none;">
            <h2>AWB Document</h2>
            <p id="pdfStatus">PDF is available for download.</p>
            <button class="btn btn-success" id="downloadPDFBtn">Download AWB PDF</button>
        </div>

        <div id="restrictedSection" class="restricted-section" style="display: none;">
            <p><strong>Access Restricted:</strong> Only the Issuing Carrier Agent can view and modify AWB form data. You can view and download the AWB PDF if it has been shared.</p>
        </div>
    </div>

    <script type="module" src="../js/api.js"></script>
    <script src="../models/user.js"></script>
    <script src="../models/shipment.js"></script>
    <script src="../js/roles.js"></script>
    <script type="module" src="../js/auth.js"></script>
    <script type="module" src="../js/shipments.js"></script>

    <script>
        // Wait for auth functions to be available (modules load asynchronously)
        (async function() {
            // Wait for auth functions to be available
            let attempts = 0;
            while ((typeof isAuthenticated === 'undefined' || typeof getCurrentUser === 'undefined' || typeof getCurrentUserAsync === 'undefined') && attempts < 50) {
                await new Promise(resolve => setTimeout(resolve, 100));
                attempts++;
            }
            
            // Wait for API to be ready before calling getCurrentUser
            if (!window.usersAPI) {
                // Wait for apiReady event (max 5 seconds)
                await new Promise((resolve) => {
                    // Check if already available
                    if (window.usersAPI) {
                        resolve();
                        return;
                    }
                    
                    // Listen for apiReady event
                    const handler = () => {
                        if (window.usersAPI) {
                            resolve();
                        }
                    };
                    window.addEventListener('apiReady', handler, { once: true });
                    
                    // Also check periodically in case event already fired
                    let checks = 0;
                    const checkInterval = setInterval(() => {
                        checks++;
                        if (window.usersAPI) {
                            window.removeEventListener('apiReady', handler);
                            clearInterval(checkInterval);
                            resolve();
                        } else if (checks >= 50) { // 5 seconds (50 * 100ms)
                            clearInterval(checkInterval);
                            resolve();
                        }
                    }, 100);
                });
            }
            
            // Give auth.js module more time to set its internal usersAPI variable
            await new Promise(resolve => setTimeout(resolve, 500));
            
            // Check authentication with error handling
            let user = null;
            try {
                // Try to get user - use window.usersAPI directly if module isn't ready
                if (window.usersAPI) {
                    try {
                        // Try direct API call first (most reliable)
                        if (window.usersAPI.getCurrent) {
                            try {
                                user = await window.usersAPI.getCurrent();
                            } catch (apiError) {
                                console.warn('API call failed:', apiError.message);
                                // If it's not a 401 (unauthorized), try using cached data
                                if (!apiError.message.includes('401') && !apiError.message.includes('Unauthorized')) {
                                    const cachedUser = getCurrentUser();
                                    if (cachedUser) {
                                        console.log('Using cached user due to API error');
                                        user = cachedUser;
                                    }
                                }
                            }
                        }
                        
                        // If direct call didn't work, try async function
                        if (!user && typeof getCurrentUserAsync !== 'undefined') {
                            try {
                                user = await getCurrentUserAsync();
                            } catch (asyncError) {
                                console.warn('getCurrentUserAsync failed:', asyncError.message);
                                const cachedUser = getCurrentUser();
                                if (cachedUser) {
                                    console.log('Using cached user after async function failed');
                                    user = cachedUser;
                                }
                            }
                        }
                    } catch (error) {
                        console.warn('Error getting user from API, trying sync version:', error);
                        await new Promise(resolve => setTimeout(resolve, 300));
                        user = getCurrentUser();
                    }
                } else {
                    await new Promise(resolve => setTimeout(resolve, 300));
                    user = getCurrentUser();
                }
                
                // If still no user, check localStorage for auth data
                if (!user) {
                    const authData = localStorage.getItem('awb_auth');
                    if (authData) {
                        try {
                            const auth = JSON.parse(authData);
                            if (auth.isAuthenticated && auth.userId) {
                                const cachedUser = getCurrentUser();
                                if (cachedUser && cachedUser.id === auth.userId) {
                                    console.log('Using cached user from localStorage auth data');
                                    user = cachedUser;
                                }
                            }
                        } catch (e) {
                            // Invalid auth data
                        }
                    }
                }
                
                // Only redirect if we truly have no user
                if (!user) {
                    console.error('No user found after authentication check');
                    window.location.href = '../login.html';
                    return;
                }
            } catch (error) {
                console.error('Authentication error:', error);
                window.location.href = '../login.html';
                return;
            }
            
            // Continue with page setup after authentication check
            setupPage(user);
        })();
        
        function setupPage(user) {
            // Get spaceId from URL
            const urlParams = new URLSearchParams(window.location.search);
            const spaceId = urlParams.get('spaceId');
            
            if (!spaceId) {
                alert('No shipment space ID provided.');
                goBack();
                return;
            }

            let currentShipment = null;

        // Load shipment space
        async function loadSpace() {
            try {
                currentShipment = await getShipmentBySpaceId(spaceId);
                
                if (!currentShipment) {
                    alert('Shipment space not found.');
                    goBack();
                    return;
                }

                // Check if user has access (admins can access all shipments)
                const isAdmin = user.role === 'admin';
                const participants = currentShipment.participants || [];
                const hasAccess = isAdmin || 
                                currentShipment.createdBy === user.id || 
                                participants.some(p => p.userId === user.id);
                
                if (!hasAccess) {
                    console.error('Access denied:', {
                        userId: user.id,
                        createdBy: currentShipment.createdBy,
                        participants: participants.map(p => p.userId),
                        isAdmin: isAdmin
                    });
                    alert('You do not have access to this shipment space.');
                    goBack();
                    return;
                }

                // Display space info - AWB number as primary, Space ID as secondary
            if (currentShipment.awbNumber) {
                document.getElementById('awbDisplay').textContent = `AWB: ${currentShipment.awbNumber}`;
                document.getElementById('awbDisplay').style.display = 'block';
                document.getElementById('spaceIdDisplay').textContent = `Space ID: ${currentShipment.spaceId}`;
            } else {
                // If no AWB yet, show Space ID as primary
                document.getElementById('awbDisplay').style.display = 'none';
                document.getElementById('spaceIdDisplay').textContent = `Space ID: ${currentShipment.spaceId}`;
                document.getElementById('spaceIdDisplay').style.fontSize = '16px';
                document.getElementById('spaceIdDisplay').style.fontWeight = 'bold';
                document.getElementById('spaceIdDisplay').style.color = '#000000';
            }

            // Status badge
            const statusBadge = document.getElementById('statusBadge');
            let statusText = currentShipment.status;
            if (currentShipment.isShared && currentShipment.status === 'active') {
                statusText = 'Shared';
                statusBadge.className = 'status-badge status-shared';
            } else {
                statusBadge.className = `status-badge status-${currentShipment.status}`;
            }
            statusBadge.textContent = statusText;

            // Show/hide sections based on role
            const isAgent = user.role === 'issuing-carrier-agent';
            // isAdmin already declared above
            const isCancelled = currentShipment.status === 'cancelled';
            
            if (isAgent || isAdmin) {
                document.getElementById('agentSection').style.display = 'block';
                
                // Show Create AWB button only for agents (not admins) and only if AWB not created yet
                if (isAgent && !currentShipment.awbNumber) {
                    document.getElementById('createAWBBtn').style.display = 'block';
                } else {
                    document.getElementById('createAWBBtn').style.display = 'none';
                }
                
                // Show Share button only for agents (not admins) and only if AWB exists and not shared yet
                if (isAgent && currentShipment.awbNumber && !currentShipment.isShared) {
                    document.getElementById('shareAWBBtn').style.display = 'block';
                } else {
                    document.getElementById('shareAWBBtn').style.display = 'none';
                }
                
                // Show delete button for agents and admins (except for deleted or in-transit shipments)
                const canDelete = (isAgent || isAdmin) && 
                                  currentShipment.status !== 'deleted' && 
                                  currentShipment.status !== 'in-transit';
                if (canDelete) {
                    document.getElementById('deleteBtn').style.display = 'block';
                } else {
                    document.getElementById('deleteBtn').style.display = 'none';
                }
                
                // Update cancel button text if cancelled
                if (isCancelled && isAgent) {
                    document.getElementById('cancelBtn').textContent = 'Uncancel Shipment';
                }
                
                // Show cancel/uncancel button only for agents (not admins)
                if (!isAgent) {
                    document.getElementById('cancelBtn').style.display = 'none';
                }
            } else {
                // Non-agents see restricted message
                document.getElementById('restrictedSection').style.display = 'block';
            }

            // Show PDF section if available and shared (or if agent or admin)
            if (currentShipment.pdfBase64 && (isAgent || isAdmin || currentShipment.isShared)) {
                document.getElementById('pdfSection').style.display = 'block';
            }

            // Load participants
            loadParticipants();

            // Disable actions if cancelled (except for agent or admin)
            if (isCancelled && !isAgent && !isAdmin) {
                // Non-agents and non-admins can't do anything with cancelled shipments
                document.getElementById('restrictedSection').innerHTML = '<p><strong>Cancelled:</strong> This shipment has been cancelled and is no longer accessible.</p>';
            }
            
            // Add Edit button for admins if AWB exists
            if (isAdmin && currentShipment.awbNumber) {
                const agentSection = document.getElementById('agentSection');
                if (agentSection) {
                    // Check if edit button already exists
                    let editBtn = document.getElementById('editAWBBtn');
                    if (!editBtn) {
                        editBtn = document.createElement('button');
                        editBtn.id = 'editAWBBtn';
                        editBtn.className = 'btn-primary';
                        editBtn.textContent = 'Edit AWB';
                        editBtn.style.marginTop = '10px';
                        editBtn.addEventListener('click', function() {
                            // Navigate to edit page
                            if (window.parent && window.parent !== window) {
                                window.parent.document.getElementById('contentFrame').src = `shipments/edit.html?awb=${currentShipment.awbNumber}`;
                            } else {
                                window.location.href = `edit.html?awb=${currentShipment.awbNumber}`;
                            }
                        });
                        agentSection.appendChild(editBtn);
                    }
                }
            }
            } catch (error) {
                console.error('Error loading shipment space:', error);
                alert('Error loading shipment space: ' + (error.message || 'Unknown error'));
                goBack();
                return;
            }
        }

        async function loadParticipants() {
            const participants = currentShipment.participants || [];
            const list = document.getElementById('participantsList');
            
            if (participants.length === 0) {
                list.innerHTML = '<p>No participants</p>';
                return;
            }

            // Check if current user is the creator (can remove participants)
            const isCreator = currentShipment.createdBy === user.id;
            const canRemove = isCreator; // Only the creator can remove participants

            // Fetch all participant users in parallel
            const participantPromises = participants.map(async (p) => {
                try {
                    let participantUser = null;
                    if (typeof window !== 'undefined' && typeof window.getUserById === 'function') {
                        participantUser = await window.getUserById(p.userId);
                    }
                    
                    const roleLabel = (typeof window !== 'undefined' && typeof window.getRoleLabel === 'function') 
                        ? window.getRoleLabel(p.role) 
                        : (p.role || 'Unknown Role');
                    const name = participantUser ? participantUser.name : 'Unknown User';
                    const isSelf = p.userId === user.id;
                    const canRemoveThis = canRemove && !isSelf; // Can't remove yourself
                    
                    let removeButton = '';
                    if (canRemoveThis) {
                        removeButton = `<button class="participant-remove" onclick="removeParticipant('${p.userId}')" title="Remove participant">Ã—</button>`;
                    }
                    
                    return `<span class="participant-badge">${name} (${roleLabel})${removeButton}</span>`;
                } catch (error) {
                    console.error('Error loading participant:', p.userId, error);
                    const roleLabel = (typeof window !== 'undefined' && typeof window.getRoleLabel === 'function') 
                        ? window.getRoleLabel(p.role) 
                        : (p.role || 'Unknown Role');
                    return `<span class="participant-badge">Unknown User (${roleLabel})</span>`;
                }
            });
            
            const participantHTML = await Promise.all(participantPromises);
            list.innerHTML = participantHTML.join('');
        }

        function removeParticipant(userId) {
            if (!confirm('Are you sure you want to remove this participant from the shipment space?')) {
                return;
            }

            // Get all shipments to update directly
            const shipments = typeof getAllShipments === 'function' ? getAllShipments() : [];
            const shipmentIndex = shipments.findIndex(s => s.spaceId === spaceId);
            
            if (shipmentIndex === -1) {
                alert('Shipment not found.');
                return;
            }

            // Get current participants
            let participants = shipments[shipmentIndex].participants || [];
            
            // Remove the participant
            const originalCount = participants.length;
            participants = participants.filter(p => p.userId !== userId);
            
            if (participants.length === originalCount) {
                alert('Participant not found in shipment.');
                return;
            }
            
            console.log('Removing participant:', userId);
            console.log('Remaining participants:', participants);

            // Update the shipment directly
            shipments[shipmentIndex].participants = participants;
            
            // Use the same storage key as shipments.js
            const SHIPMENTS_STORAGE_KEY = 'awb_shipments';
            localStorage.setItem(SHIPMENTS_STORAGE_KEY, JSON.stringify(shipments));

            alert('Participant removed successfully.');
            loadSpace(); // Reload to update UI
        }

        // Make function available globally for onclick handlers
        window.removeParticipant = removeParticipant;

        // Button handlers
        document.getElementById('createAWBBtn').addEventListener('click', function() {
            // Store spaceId and redirect to create-awb.html
            sessionStorage.setItem('currentSpaceId', spaceId);
            if (window.parent && window.parent !== window) {
                window.parent.document.getElementById('contentFrame').src = '../create-awb.html?spaceId=' + spaceId;
            } else {
                window.location.href = '../create-awb.html?spaceId=' + spaceId;
            }
        });

        document.getElementById('shareAWBBtn').addEventListener('click', function() {
            if (confirm('Are you sure you want to share this AWB with all participants? They will be able to view and download the PDF.')) {
                const result = shareShipment(spaceId);
                if (result.success) {
                    alert('AWB shared successfully with participants!');
                    loadSpace(); // Reload to update UI
                } else {
                    alert('Error sharing AWB: ' + result.message);
                }
            }
        });

        document.getElementById('cancelBtn').addEventListener('click', function() {
            if (currentShipment.status === 'cancelled') {
                // Uncancel
                if (confirm('Are you sure you want to uncancel this shipment?')) {
                    const result = uncancelShipment(spaceId);
                    if (result.success) {
                        alert('Shipment uncancelled successfully.');
                        loadSpace();
                    } else {
                        alert('Error: ' + result.message);
                    }
                }
            } else {
                // Cancel
                if (confirm('Are you sure you want to cancel this shipment? Participants will no longer be able to access it.')) {
                    const result = cancelShipment(spaceId);
                    if (result.success) {
                        alert('Shipment cancelled successfully.');
                        loadSpace();
                    } else {
                        alert('Error: ' + result.message);
                    }
                }
            }
        });

        document.getElementById('deleteBtn').addEventListener('click', async function() {
            if (confirm('Are you sure you want to permanently delete this shipment space? This action cannot be undone.')) {
                if (confirm('This is your final confirmation. The shipment will be permanently deleted.')) {
                    try {
                        const result = await deleteShipment(spaceId);
                        if (result.success) {
                            alert('Shipment deleted successfully.');
                            goBack();
                        } else {
                            alert('Error: ' + result.message);
                        }
                    } catch (error) {
                        console.error('Error deleting shipment:', error);
                        alert('Error deleting shipment: ' + (error.message || 'Unknown error'));
                    }
                }
            }
        });

        document.getElementById('downloadPDFBtn').addEventListener('click', function() {
            if (!currentShipment.pdfBase64) {
                alert('PDF not available.');
                return;
            }

            try {
                const binaryString = atob(currentShipment.pdfBase64);
                const bytes = new Uint8Array(binaryString.length);
                for (let i = 0; i < binaryString.length; i++) {
                    bytes[i] = binaryString.charCodeAt(i);
                }
                const blob = new Blob([bytes], { type: 'application/pdf' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `AWB-${currentShipment.awbNumber || currentShipment.spaceId}.pdf`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            } catch (error) {
                console.error('Error downloading PDF:', error);
                alert('Error downloading PDF: ' + error.message);
            }
        });

        function goBack() {
            if (window.parent && window.parent !== window) {
                // In iframe - path is relative to dashboard.html (root directory)
                window.parent.document.getElementById('contentFrame').src = 'shipments/list.html';
            } else {
                // Not in iframe - path is relative to current file (shipments/ directory)
                window.location.href = 'list.html';
            }
        }
        
        // Load space on page load (inside setupPage)
        loadSpace();
        }
    </script>
</body>
</html>
