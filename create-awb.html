<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create AWB - Airway Bills</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <header>
            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px;">
                <div>
                    <h1 style="margin: 0;">Create Airway Bill</h1>
                    <p style="margin: 5px 0 0 0;">Fill out the form below to generate your completed PDF</p>
                </div>
                <div id="iframeNavigation" style="display: none;">
                    <button onclick="goBackToShipments()" style="padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px;">
                        ← Back to Shipments
                    </button>
                </div>
            </div>
        </header>

        <div class="loading" id="loading" style="display: none;">
            <div class="spinner"></div>
            <p>Processing PDF...</p>
        </div>

        <div class="error" id="error" style="display: none;"></div>

        <div class="content-wrapper" id="contentWrapper" style="display: none;">
            <div class="form-section" id="formSection">
                <div class="template-section" id="templateSection">
                    <div class="template-controls" id="templateControls">
                        <div class="template-select-group" id="templateSelectGroup">
                            <label for="templateSelect">Template:</label>
                            <select id="templateSelect" class="template-select">
                                <option value="">-- Select Template --</option>
                            </select>
                        </div>
                        <div class="template-name-group" id="templateNameGroup" style="display: none;">
                            <label for="templateNameInput">Template Name:</label>
                            <input type="text" id="templateNameInput" class="template-name-input" placeholder="Enter template name">
                        </div>
                        <div class="template-buttons" id="templateButtons">
                            <button type="button" class="btn-template" id="saveTemplateBtn">Save Template</button>
                            <button type="button" class="btn-template" id="deleteTemplateBtn" style="display: none;">Delete</button>
                            <button type="button" class="btn-template" id="renameTemplateBtn" style="display: none;">Rename</button>
                            <button type="button" class="btn-template btn-clear" id="clearFormBtn">Clear Form</button>
                        </div>
                    </div>
                    <!-- Template from Shipment button (shown only when editing) -->
                </div>
                
                <!-- Tabs Navigation -->
                <div class="awb-tabs">
                    <button class="awb-tab-button active" data-tab="contacts">
                        Contacts
                        <span class="tab-validation-indicator" id="contacts-validation-indicator"></span>
                    </button>
                    <button class="awb-tab-button" data-tab="routing">
                        Routing
                        <span class="tab-validation-indicator" id="routing-validation-indicator"></span>
                    </button>
                    <button class="awb-tab-button" data-tab="dimensions">
                        Dimensions
                        <span class="tab-validation-indicator" id="dimensions-validation-indicator"></span>
                    </button>
                    <button class="awb-tab-button" data-tab="billing">
                        Billing
                        <span class="tab-validation-indicator" id="billing-validation-indicator"></span>
                    </button>
                    <button class="awb-tab-button" data-tab="form">
                        Preview AWB
                        <span class="tab-validation-indicator" id="form-validation-indicator"></span>
                    </button>
                </div>
                
                <!-- Preview AWB Tab -->
                <div id="form-tab" class="awb-tab-content">
                    <div class="form-header">
                        <h2>Preview AWB</h2>
                        <p style="color: #666; font-size: 14px; margin-top: 5px;">This preview shows how your AWB will look when downloaded (flattened PDF)</p>
                    </div>
                    <div style="display: flex; justify-content: center; align-items: center; margin-top: 20px;">
                        <div id="pdfPreviewContainer" style="width: 100%; max-width: 900px; height: 700px; border: 2px solid #ddd; border-radius: 8px; background: #f5f5f5; overflow: hidden; position: relative; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                            <div id="pdfPreviewLoading" style="text-align: center; color: #666; width: 100%; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 1;">
                                <p>Fill out the form fields to see a preview of your AWB</p>
                                <p style="font-size: 12px; margin-top: 10px;">Click "Refresh Preview" to update the preview</p>
                            </div>
                            <iframe id="pdfPreviewFrame" style="border: none; display: none; background: white; width: 100%; height: 100%; position: absolute; top: 0; left: 0; z-index: 2;"></iframe>
                        </div>
                    </div>
                    <div style="margin-top: 15px; text-align: center;">
                        <button type="button" id="refreshPreviewBtn" class="btn-secondary" style="padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px;">
                            Refresh Preview
                        </button>
                    </div>
                </div>
                
                <!-- Contacts Tab -->
                <div id="contacts-tab" class="awb-tab-content active">
                    <div class="contact-section" id="contactSection" style="display: none;">
                        <div class="contact-controls">
                            <div class="contact-select-group">
                                <label for="shipperSelect">Shipper (04. SNA):</label>
                                <select id="shipperSelect" class="contact-select">
                                    <option value="">-- Select Shipper --</option>
                                </select>
                                <button type="button" class="btn-contact-small" id="addShipperBtn">+ Add</button>
                            </div>
                            <div class="contact-select-group">
                                <label for="consigneeSelect">Consignee (05. CNA):</label>
                                <select id="consigneeSelect" class="contact-select">
                                    <option value="">-- Select Consignee --</option>
                                </select>
                                <button type="button" class="btn-contact-small" id="addConsigneeBtn">+ Add</button>
                            </div>
                        </div>
                    </div>
                    <div class="contact-fields-container" id="contactFieldsContainer">
                        <form id="contactFieldsForm" onsubmit="return false;">
                            <!-- Fields 04, 05, 06, 07 will be displayed here -->
                        </form>
                    </div>
                </div>
                
                <!-- Routing Tab -->
                <div id="routing-tab" class="awb-tab-content">
                    <div class="routing-controls-section" id="routingControlsSection" style="display: none;">
                        <div class="routing-controls">
                            <div class="contact-select-group">
                                <label for="airlineSelect1">Issuing Carrier:</label>
                                <select id="airlineSelect1" class="contact-select">
                                    <option value="">-- Select Airline --</option>
                                </select>
                                <button type="button" class="btn-contact-small" id="addAirlineBtn1">+ Add</button>
                            </div>
                            <div class="contact-select-group">
                                <label for="destinationSelect">Destination:</label>
                                <select id="destinationSelect" class="contact-select" required>
                                    <option value="">-- Select Destination --</option>
                                </select>
                                <button type="button" class="btn-contact-small" id="addDestinationBtn">+ Add</button>
                            </div>
                            <div class="contact-select-group">
                                <label for="directFlightSelect">Direct Flight:</label>
                                <select id="directFlightSelect" class="contact-select">
                                    <option value="">-- Select --</option>
                                    <option value="Yes">Yes</option>
                                    <option value="No">No</option>
                                </select>
                            </div>
                            <div class="contact-select-group">
                                <label for="interlineShipmentSelect">Interline Shipment:</label>
                                <select id="interlineShipmentSelect" class="contact-select">
                                    <option value="">-- Select --</option>
                                    <option value="Yes">Yes</option>
                                    <option value="No">No</option>
                                </select>
                            </div>
                            <div class="contact-select-group" id="interlineCarrierGroup" style="display: none;">
                                <label for="interlineCarrierSelect1">Interline Carrier 1:</label>
                                <select id="interlineCarrierSelect1" class="contact-select">
                                    <option value="">-- Select Airline --</option>
                                </select>
                            </div>
                            <div class="contact-select-group" id="addInterlineCarrier2BtnGroup" style="display: none; justify-content: center;">
                                <button type="button" class="btn-contact-small" id="addInterlineCarrier2Btn">+ Add Interline Carrier 2</button>
                            </div>
                            <div class="contact-select-group" id="interlineCarrierGroup2" style="display: none;">
                                <label for="interlineCarrierSelect2">Interline Carrier 2:</label>
                                <select id="interlineCarrierSelect2" class="contact-select">
                                    <option value="">-- Select Airline --</option>
                                </select>
                            </div>
                            <div class="contact-select-group">
                                <label for="dangerousGoodsSelect" style="color: red;">Dangerous Goods: *</label>
                                <select id="dangerousGoodsSelect" class="contact-select" required>
                                    <option value="">-- Select --</option>
                                    <option value="Yes">Yes</option>
                                    <option value="No">No</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="form-header">
                        <h2>Routing Information</h2>
                    </div>
                    <form id="generatedForm" onsubmit="return false;">
                        <!-- Dynamically generated form fields will appear here -->
                    </form>
                </div>
                
                <!-- Dimensions Tab -->
                <div id="dimensions-tab" class="awb-tab-content">
                    <div class="form-header">
                        <h2>Dimensions</h2>
                        <p style="color: #666; font-size: 14px; margin-top: 5px;">Enter package dimensions and quantities</p>
                    </div>
                    <div class="dimensions-controls-section" id="dimensionsControlsSection" style="display: block;">
                        <div class="routing-controls">
                            <div class="contact-select-group dimensions-group">
                                <label>Dimensions:</label>
                                <div class="dimensions-container" id="dimensionsContainer">
                                    <div class="dimensions-row" data-row-index="0" style="position: relative;">
                                        <button type="button" class="dim-minimize-btn" id="minimizeDimensionsBtn" style="display: none;">▼</button>
                                        <input type="number" class="dim-input dim-length" placeholder="L (cm)" min="0" step="0.1">
                                        <input type="number" class="dim-input dim-width" placeholder="W (cm)" min="0" step="0.1">
                                        <input type="number" class="dim-input dim-height" placeholder="H (cm)" min="0" step="0.1">
                                        <input type="number" class="dim-input dim-qty" placeholder="QTY" min="1" step="1">
                                        <button type="button" class="dim-add-box-btn" id="addDimensionsBoxBtn">+ Add Box</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Billing Tab -->
                <div id="billing-tab" class="awb-tab-content">
                    <div class="billing-controls-section" id="billingControlsSection" style="display: block;">
                        <div class="routing-controls">
                            <div class="contact-select-group">
                                <label for="declaredValuesSelect">Declared Values:</label>
                                <select id="declaredValuesSelect" class="contact-select">
                                    <option value="">-- Select --</option>
                                    <option value="Yes">Yes</option>
                                    <option value="No">No</option>
                                </select>
                            </div>
                            <div class="contact-select-group">
                                <label for="insuranceSelect">Insurance:</label>
                                <select id="insuranceSelect" class="contact-select">
                                    <option value="">-- Select --</option>
                                    <option value="Yes">Yes</option>
                                    <option value="No">No</option>
                                </select>
                            </div>
                            <div class="contact-select-group">
                                <label for="prepaidCollectSelect">Prepaid or Collect:</label>
                                <select id="prepaidCollectSelect" class="contact-select">
                                    <option value="">-- Select --</option>
                                    <option value="Prepaid">Prepaid</option>
                                    <option value="Collect">Collect</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="form-header">
                        <h2>Billing Information</h2>
                    </div>
                    <form id="billingFieldsForm">
                        <!-- Dynamically generated billing fields will appear here -->
                    </form>
                </div>
                
                <!-- Form Actions - Appears at bottom of all tabs -->
                <div class="form-actions">
                    <button type="button" class="btn-primary" id="fillAndFlattenBtn" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%);">Create AWB</button>
                    <button type="button" class="btn-secondary" id="printPreviewBtn">Print Preview</button>
                    <button type="button" class="btn-secondary" id="submitBtn">View Form Data</button>
                </div>
            </div>
        </div>

        <div class="results" id="results" style="display: none;">
            <h3>Form Data</h3>
            <pre id="resultsContent"></pre>
        </div>
    </div>

    <!-- Contact Management Modal -->
    <div id="contactModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Add Contact</h2>
                <button type="button" class="modal-close" id="closeContactModal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="contactForm">
                    <input type="hidden" id="contactId" value="">
                    <input type="hidden" id="contactType" value="">
                    
                    <div class="form-group">
                        <label for="contactCompanyName">Company Name *</label>
                        <input type="text" id="contactCompanyName" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="contactName" id="contactNameLabel">Contact Name *</label>
                        <input type="text" id="contactName" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="contactEmail" id="contactEmailLabel">Email *</label>
                        <input type="email" id="contactEmail" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="contactPhone" id="contactPhoneLabel">Phone Number *</label>
                        <input type="tel" id="contactPhone" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="contactAddress" id="contactAddressLabel">Address *</label>
                        <textarea id="contactAddress" rows="3" required></textarea>
                    </div>
                    
                    <div class="form-group" id="formattedValueGroup">
                        <label for="contactFormattedValue" id="formattedValueLabel">Formatted Field Value *</label>
                        <textarea id="contactFormattedValue" rows="4" required placeholder="This will be used to fill the form field. Format: Company Name\nContact Name\nEmail\nPhone\nAddress"></textarea>
                        <small>This value will be used to fill the form field. Use line breaks (\n) to format.</small>
                    </div>
                    
                    <div class="form-group" id="originInfoGroup" style="display: none;">
                        <label for="contactOrigin">Origin (02. ORIGIN)</label>
                        <input type="text" id="contactOrigin" placeholder="Enter origin information">
                        <small>This will be used to auto-fill field 02. ORIGIN when the form loads.</small>
                    </div>
                    
                    <div class="form-group" id="aoDEPInfoGroup" style="display: none;">
                        <label for="contactAoDEP">AoDEP (08. AoDEP)</label>
                        <input type="text" id="contactAoDEP" placeholder="Enter AoDEP information">
                        <small>This will be used to auto-fill field 08. AoDEP when the form loads.</small>
                    </div>
                    
                    <div class="form-group" id="handlingInfoGroup" style="display: none;">
                        <label for="contactHandlingInfo">Handling Info (22. HANDLING INFO)</label>
                        <textarea id="contactHandlingInfo" placeholder="Enter handling information" rows="4"></textarea>
                        <small>This will be used to auto-fill field 22. HANDLING INFO when the form loads.</small>
                    </div>
                    
                    <div class="form-group" id="contactField06Group" style="display: none;">
                        <label for="contactField06">AWB form Autofill 06</label>
                        <textarea id="contactField06" rows="4" placeholder="Enter agent name and address information. Use line breaks to format."></textarea>
                        <small>This will be used to auto-fill field 06. AGENT NAME when the form loads. Format: Company Name\nContact Name\nEmail\nPhone\nAddress</small>
                    </div>
                    
                    <div class="form-group" id="awbpInfoGroup" style="display: none;">
                        <label for="contactAWBP">AWBP (01. AWBP)</label>
                        <input type="text" id="contactAWBP" placeholder="Enter AWBP (Air Waybill Prefix)">
                        <small>This will be used to auto-fill field 01. AWBP when this airline is selected.</small>
                    </div>
                    
                    <div class="form-group" id="airlineAbbreviationGroup" style="display: none;">
                        <label for="contactAirlineAbbreviation">Airline Abbreviation</label>
                        <input type="text" id="contactAirlineAbbreviation" placeholder="Enter Airline Abbreviation">
                        <small>This abbreviation will be stored with the airline contact.</small>
                    </div>
                    
                    <div class="form-group" id="airlineImageGroup" style="display: none;">
                        <label for="contactAirlineImage">Airline Logo/Image</label>
                        <input type="file" id="contactAirlineImage" accept="image/*">
                        <small>Upload an image/logo for this airline (JPG, PNG, etc.)</small>
                        <div id="airlineImagePreview" style="margin-top: 10px; display: none;">
                            <img id="airlineImagePreviewImg" src="" alt="Preview" style="max-width: 200px; max-height: 100px; border: 1px solid #ddd; border-radius: 4px; padding: 5px;">
                            <button type="button" id="removeAirlineImageBtn" style="margin-left: 10px; padding: 5px 10px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer;">Remove Image</button>
                        </div>
                    </div>
                    
                    <div class="form-group" id="accountInfoGroup" style="display: none;">
                        <label for="contactAccountInfo">Account Info (07. ACCNT INFO)</label>
                        <textarea id="contactAccountInfo" rows="3" placeholder="Enter account information for this consignee"></textarea>
                        <small>This will be used to fill field 07. ACCNT INFO when this consignee is selected.</small>
                    </div>
                    
                    <div class="modal-actions">
                        <button type="button" class="btn-secondary" id="cancelContactBtn">Cancel</button>
                        <button type="submit" class="btn-primary" id="saveContactBtn">Save Contact</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal for Missing Fields -->
    <div id="missingFieldsModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Missing Fields</h2>
            </div>
            <div class="modal-body">
                <p>The following fields are missing:</p>
                <div id="missingFieldsList" style="margin: 20px 0; padding: 15px; background: #f8f9fa; border-radius: 6px; max-height: 300px; overflow-y: auto;">
                    <!-- Missing fields will be listed here -->
                </div>
                <p style="margin-top: 15px; font-weight: 600;">Do you want to continue anyway?</p>
            </div>
            <div class="modal-actions">
                <button type="button" class="btn-secondary" id="cancelMissingFieldsBtn">Cancel</button>
                <button type="button" class="btn-primary" id="confirmMissingFieldsBtn">Continue</button>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"></script>
    <script src="app4.js"></script>
    
    <!-- Load shipment management scripts (for saving AWB data) -->
    <script type="module" src="js/api.js"></script>
    <script src="models/user.js"></script>
    <script src="models/shipment.js"></script>
    <script src="js/roles.js"></script>
    <script type="module" src="js/auth.js"></script>
    <script type="module" src="js/shipments.js"></script>
    
    <script>
        // Tab switching functionality
        document.querySelectorAll('.awb-tab-button').forEach(button => {
            button.addEventListener('click', () => {
                const tabName = button.getAttribute('data-tab');
                
                // Update active tab button
                document.querySelectorAll('.awb-tab-button').forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');
                
                // Update active tab content
                document.querySelectorAll('.awb-tab-content').forEach(content => content.classList.remove('active'));
                document.getElementById(`${tabName}-tab`).classList.add('active');
                
                // Update prompt indicators when switching tabs
                if (typeof updatePromptIndicators === 'function') {
                    setTimeout(() => updatePromptIndicators(), 100);
                }
            });
        });

        // This is the CREATE page - no edit mode logic needed
        
        // Function to collect complete form data including dropdowns, dimensions, and dangerous goods
        function collectCompleteFormData() {
            const formData = typeof collectFormData === 'function' ? collectFormData() : {};
            
            // Collect ALL dropdown selections
            const dropdownData = {};
            
            // Contact dropdowns - also capture linked user IDs
            const shipperSelect = document.getElementById('shipperSelect');
            const consigneeSelect = document.getElementById('consigneeSelect');
            if (shipperSelect) {
                dropdownData.shipperContactId = shipperSelect.value || '';
                // Find linked user if contact is selected
                if (shipperSelect.value) {
                    const contacts = typeof getContacts === 'function' ? getContacts() : [];
                    const shipperContact = contacts.find(c => c.id === shipperSelect.value);
                    if (shipperContact && shipperContact.linkedUserId) {
                        dropdownData.shipperUserId = shipperContact.linkedUserId;
                    }
                }
            }
            if (consigneeSelect) {
                dropdownData.consigneeContactId = consigneeSelect.value || '';
                // Find linked user if contact is selected
                if (consigneeSelect.value) {
                    const contacts = typeof getContacts === 'function' ? getContacts() : [];
                    const consigneeContact = contacts.find(c => c.id === consigneeSelect.value);
                    if (consigneeContact && consigneeContact.linkedUserId) {
                        dropdownData.consigneeUserId = consigneeContact.linkedUserId;
                    }
                }
            }
            
            // Routing dropdowns
            const airlineSelect1 = document.getElementById('airlineSelect1');
            const destinationSelect = document.getElementById('destinationSelect');
            const directFlightSelect = document.getElementById('directFlightSelect');
            const interlineCarrierSelect1 = document.getElementById('interlineCarrierSelect1');
            const interlineCarrierSelect2 = document.getElementById('interlineCarrierSelect2');
            if (airlineSelect1) dropdownData.airlineId = airlineSelect1.value || '';
            if (destinationSelect) dropdownData.destination = destinationSelect.value || '';
            if (directFlightSelect) dropdownData.directFlight = directFlightSelect.value || '';
            if (interlineCarrierSelect1) dropdownData.interlineCarrier1 = interlineCarrierSelect1.value || '';
            if (interlineCarrierSelect2) dropdownData.interlineCarrier2 = interlineCarrierSelect2.value || '';
            
            // Billing dropdowns
            const declaredValuesSelect = document.getElementById('declaredValuesSelect');
            const insuranceSelect = document.getElementById('insuranceSelect');
            const prepaidCollectSelect = document.getElementById('prepaidCollectSelect');
            if (declaredValuesSelect) dropdownData.declaredValues = declaredValuesSelect.value || '';
            if (insuranceSelect) dropdownData.insurance = insuranceSelect.value || '';
            if (prepaidCollectSelect) dropdownData.prepaidCollect = prepaidCollectSelect.value || '';
            
            // Dangerous Goods dropdown
            const dangerousGoodsSelect = document.getElementById('dangerousGoodsSelect');
            if (dangerousGoodsSelect) dropdownData.dangerousGoods = dangerousGoodsSelect.value || '';
            
            // Collect dimensions data (including QTY for shipments)
            const dimensionsData = [];
            const dimensionsContainer = document.getElementById('dimensionsContainer');
            if (dimensionsContainer) {
                const dimensionsRows = dimensionsContainer.querySelectorAll('.dimensions-row');
                dimensionsRows.forEach((row) => {
                    const lengthInput = row.querySelector('.dim-length');
                    const widthInput = row.querySelector('.dim-width');
                    const heightInput = row.querySelector('.dim-height');
                    const qtyInput = row.querySelector('.dim-qty');
                    
                    if (lengthInput || widthInput || heightInput || qtyInput) {
                        dimensionsData.push({
                            length: lengthInput ? lengthInput.value : '',
                            width: widthInput ? widthInput.value : '',
                            height: heightInput ? heightInput.value : '',
                            qty: qtyInput ? qtyInput.value : '' // Include QTY for shipments
                        });
                    }
                });
            }
            if (dimensionsData.length > 0) {
                dropdownData.dimensions = dimensionsData;
            }
            
            return {
                formData: formData,
                dropdownData: dropdownData
            };
        }
        
        // Function to go back to shipments
        function goBackToShipments() {
            if (window.parent && window.parent !== window) {
                // We're in an iframe - tell parent to load shipments list
                const contentFrame = window.parent.document.getElementById('contentFrame');
                if (contentFrame) {
                    contentFrame.src = 'shipments/list.html';
                    // Update active nav item
                    const parentNavLinks = window.parent.document.querySelectorAll('.nav-menu a');
                    parentNavLinks.forEach(link => link.classList.remove('active'));
                    const shipmentsLink = Array.from(parentNavLinks).find(link => 
                        link.getAttribute('href') && link.getAttribute('href').includes('shipments')
                    );
                    if (shipmentsLink) {
                        shipmentsLink.classList.add('active');
                    }
                }
            } else {
                // Not in iframe - redirect
                window.location.href = 'shipments/list.html';
            }
        }
        
        // Clear any edit mode flags and saved form data - this is the CREATE page only
        sessionStorage.removeItem('isEditingShipment');
        sessionStorage.removeItem('loadShipmentAWB');
        
        // Clear any saved form data to ensure form starts fresh
        localStorage.removeItem('awbFormData');
        console.log('✅ Cleared saved form data - form will start fresh');
        
        // PDF Preview functionality
        let previewTimeout = null;
        
        // Function to generate and display PDF preview
        window.generatePDFPreview = async function() {
            const previewContainer = document.getElementById('pdfPreviewContainer');
            const previewLoading = document.getElementById('pdfPreviewLoading');
            const previewFrame = document.getElementById('pdfPreviewFrame');
            
            if (!previewContainer || !previewLoading || !previewFrame) {
                console.warn('Preview elements not found');
                return;
            }
            
            // Check if required functions are available
            if (typeof collectFormData === 'undefined' || typeof fillPdfWithData === 'undefined') {
                previewLoading.innerHTML = '<p style="color: #999;">PDF preview will be available after the form loads</p>';
                return;
            }
            
            try {
                previewLoading.style.display = 'block';
                previewFrame.style.display = 'none';
                previewLoading.innerHTML = '<p>Generating preview...</p>';
                
                // Collect form data
                const formData = collectFormData();
                
                // Generate flattened PDF
                const pdfBytes = await fillPdfWithData(formData, true); // true = flattened
                
                // Create blob and display in iframe
                const blob = new Blob([pdfBytes], { type: 'application/pdf' });
                const url = URL.createObjectURL(blob);
                
                // Set iframe to fill the container and fit the document
                previewFrame.style.width = '100%';
                previewFrame.style.height = '100%';
                previewFrame.style.display = 'block';
                previewFrame.style.position = 'absolute';
                previewFrame.style.top = '0';
                previewFrame.style.left = '0';
                previewFrame.style.border = 'none';
                
                // Use page-fit zoom to display entire document within the frame
                previewFrame.src = url + '#zoom=page-fit&toolbar=0&navpanes=0&scrollbar=0';
                
                previewLoading.style.display = 'none';
                
                // Clean up old URL after a delay
                if (previewFrame.dataset.oldUrl) {
                    URL.revokeObjectURL(previewFrame.dataset.oldUrl);
                }
                previewFrame.dataset.oldUrl = url;
                
                console.log('✅ PDF preview generated and displayed');
            } catch (error) {
                console.error('Error generating PDF preview:', error);
                previewLoading.innerHTML = `<p style="color: #dc3545;">Error generating preview: ${error.message}</p>`;
                previewLoading.style.display = 'block';
                previewFrame.style.display = 'none';
            }
        }
        
        // Refresh preview button handler
        const refreshPreviewBtn = document.getElementById('refreshPreviewBtn');
        if (refreshPreviewBtn) {
            refreshPreviewBtn.addEventListener('click', async () => {
                await generatePDFPreview();
            });
        }
        
        // Generate preview when Preview AWB tab is clicked
        document.addEventListener('DOMContentLoaded', () => {
            // Wait for tabs to be initialized
            setTimeout(() => {
                const formTabButton = document.querySelector('.awb-tab-button[data-tab="form"]');
                if (formTabButton) {
                    formTabButton.addEventListener('click', () => {
                        // Debounce preview generation
                        clearTimeout(previewTimeout);
                        previewTimeout = setTimeout(() => {
                            generatePDFPreview();
                        }, 300);
                    });
                }
            }, 500);
        });
        
        // Also listen for tab changes via the existing tab system
        // Hook into the tab switching to generate preview when form tab becomes active
        const originalTabSwitch = window.addEventListener;
        const observer = new MutationObserver((mutations) => {
            const formTab = document.getElementById('form-tab');
            if (formTab && formTab.classList.contains('active')) {
                // Form tab is now active, generate preview
                clearTimeout(previewTimeout);
                previewTimeout = setTimeout(() => {
                    generatePDFPreview();
                }, 300);
            }
        });
        
        // Start observing when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
                const formTab = document.getElementById('form-tab');
                if (formTab) {
                    observer.observe(formTab, { attributes: true, attributeFilter: ['class'] });
                }
            });
        } else {
            const formTab = document.getElementById('form-tab');
            if (formTab) {
                observer.observe(formTab, { attributes: true, attributeFilter: ['class'] });
            }
        }
        
        // Check if we're creating AWB for a shipment space
        const urlParams = new URLSearchParams(window.location.search);
        const spaceId = urlParams.get('spaceId') || sessionStorage.getItem('currentSpaceId');
        
        // Hook into "Create AWB" button to save PDF to shipment space without downloading
        (function() {
            let shipmentUpdated = false; // Prevent duplicate updates
            
            // Override the button click handler after app4.js sets it up
            setTimeout(() => {
                const createAWBBtn = document.getElementById('fillAndFlattenBtn');
                if (createAWBBtn && spaceId) {
                    // Remove all existing event listeners by cloning the button
                    const newBtn = createAWBBtn.cloneNode(true);
                    createAWBBtn.parentNode.replaceChild(newBtn, createAWBBtn);
                    
                    newBtn.addEventListener('click', async function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        
                        // Check if we have a spaceId - if not, fall back to download behavior
                        if (!spaceId) {
                            console.log('No spaceId - falling back to download behavior');
                            if (typeof handleFillPdf !== 'undefined') {
                                await handleFillPdf(true);
                            }
                            return;
                        }
                        
                        // Directly save to shipment space without downloading
                        await createShipmentWithPDF();
                    });
                    
                    console.log('✅ Create AWB button handler overridden for shipment space mode');
                }
            }, 1000); // Wait for app4.js to initialize
            
            // Function to update shipment space with AWB and PDF
            async function createShipmentWithPDF() {
                if (shipmentUpdated) {
                    return;
                }
                
                console.log('✅ Saving AWB to shipment space...');
                
                if (typeof getCurrentUser === 'undefined' || typeof collectFormData === 'undefined' || typeof updateShipment === 'undefined' || typeof fillPdfWithData === 'undefined') {
                    console.error('Required functions not available');
                    alert('Error: Required functions not loaded. Please refresh the page.');
                    return;
                }
                
                // Update validation indicators before checking
                if (typeof updateTabValidationIndicators === 'function') {
                    updateTabValidationIndicators();
                }
                
                // Check for missing required fields
                if (typeof getMissingFieldNames === 'function') {
                    const missingFields = getMissingFieldNames();
                    if (missingFields.length > 0) {
                        const fieldList = missingFields.map(field => `• ${field}`).join('\n');
                        const message = `The following required fields are missing:\n\n${fieldList}\n\nDo you want to continue anyway?`;
                        if (!confirm(message)) {
                            return; // User cancelled
                        }
                    }
                }
                
                // Show loading state
                const loadingEl = document.getElementById('loading');
                const errorEl = document.getElementById('error');
                const contentWrapper = document.getElementById('contentWrapper');
                if (loadingEl) {
                    loadingEl.style.display = 'block';
                }
                if (errorEl) {
                    errorEl.style.display = 'none';
                }
                if (contentWrapper) {
                    contentWrapper.style.opacity = '0.5';
                    contentWrapper.style.pointerEvents = 'none';
                }
                
                // Disable the button to prevent double-clicks
                const createBtn = document.getElementById('fillAndFlattenBtn');
                if (createBtn) {
                    createBtn.disabled = true;
                    createBtn.textContent = 'Creating AWB...';
                }
                
                const user = getCurrentUser();
                // Only agents can create AWBs, admins can view/edit but not create
                if (!user || user.role !== 'issuing-carrier-agent') {
                    // If admin, allow viewing/editing but prevent creation
                    if (user && user.role === 'admin') {
                        // Check if this is a new AWB creation (no spaceId means new)
                        const urlParams = new URLSearchParams(window.location.search);
                        const spaceId = urlParams.get('spaceId') || sessionStorage.getItem('currentSpaceId');
                        if (!spaceId) {
                            alert('Administrators cannot create new AWBs. Please use an existing shipment space.');
                            if (window.parent && window.parent !== window) {
                                window.parent.document.getElementById('contentFrame').src = 'shipments/list.html';
                            } else {
                                window.location.href = 'shipments/list.html';
                            }
                            return;
                        }
                        // Admin can edit existing AWBs, so continue
                    } else {
                        return;
                    }
                }
                
                // Check if we have a spaceId
                if (!spaceId) {
                    console.log('No spaceId - creating new shipment (legacy mode)');
                    // Fall back to old behavior - create new shipment
                    await createNewShipment();
                    return;
                }
                
                try {
                    // Get the existing shipment space
                    const shipment = getShipmentBySpaceId(spaceId);
                    if (!shipment) {
                        console.error('Shipment space not found:', spaceId);
                        return;
                    }
                    
                    // Collect COMPLETE form data including dropdowns
                    const completeFormData = collectCompleteFormData();
                    const formData = completeFormData.formData; // For PDF generation
                    
                    console.log('Complete form data collected (including dropdowns):', completeFormData);
                    
                    // Regenerate PDF to get bytes (since we can't intercept the original)
                    console.log('Generating PDF to store in shipment...');
                    const pdfBytes = await fillPdfWithData(formData, true); // true = flattened
                    
                    // Convert PDF bytes to base64 for storage
                    const uint8Array = new Uint8Array(pdfBytes);
                    let binaryString = '';
                    const chunkSize = 8192; // Process in chunks to avoid stack overflow
                    for (let i = 0; i < uint8Array.length; i += chunkSize) {
                        const chunk = uint8Array.slice(i, i + chunkSize);
                        binaryString += String.fromCharCode.apply(null, chunk);
                    }
                    const pdfBase64 = btoa(binaryString);
                    
                    console.log('PDF converted to base64, size:', (pdfBase64.length / 1024).toFixed(2), 'KB');
                    
                    // Extract AWB number (prioritize field 101)
                    let awbNumberFromForm = null;
                    for (const key in formData) {
                        if (key.startsWith('101') && formData[key]) {
                            const value = String(formData[key]).trim();
                            if (value && value.includes('-')) {
                                awbNumberFromForm = value;
                                console.log('✅ Found AWB in field 101:', awbNumberFromForm);
                                break;
                            }
                        }
                    }
                    if (!awbNumberFromForm) {
                        for (const key in formData) {
                            if (key.startsWith('01') && formData[key]) {
                                awbNumberFromForm = String(formData[key]).trim();
                                break;
                            }
                        }
                    }
                    
                    // Auto-add linked users as participants
                    const participantsToAdd = [];
                    const dropdownData = completeFormData.dropdownData || {};
                    
                    // Check for shipper user
                    if (dropdownData.shipperUserId) {
                        const users = typeof getAllUsers === 'function' ? getAllUsers() : [];
                        const shipperUser = users.find(u => u.id === dropdownData.shipperUserId);
                        if (shipperUser) {
                            participantsToAdd.push({
                                userId: shipperUser.id,
                                role: shipperUser.role,
                                invitedBy: user.id
                            });
                            console.log('✅ Auto-adding shipper user as participant:', shipperUser.name);
                        }
                    }
                    
                    // Check for consignee user
                    if (dropdownData.consigneeUserId) {
                        const users = typeof getAllUsers === 'function' ? getAllUsers() : [];
                        const consigneeUser = users.find(u => u.id === dropdownData.consigneeUserId);
                        if (consigneeUser) {
                            participantsToAdd.push({
                                userId: consigneeUser.id,
                                role: consigneeUser.role,
                                invitedBy: user.id
                            });
                            console.log('✅ Auto-adding consignee user as participant:', consigneeUser.name);
                        }
                    }
                    
                    // Update the shipment space with AWB data
                    const updates = {
                        formData: completeFormData, // Save COMPLETE data structure with dropdowns
                        pdfBase64: pdfBase64,
                        pdfCreatedAt: new Date().toISOString()
                    };
                    if (awbNumberFromForm) {
                        updates.awbNumber = awbNumberFromForm;
                    }
                    
                    // Add participants if any
                    if (participantsToAdd.length > 0) {
                        // Get current shipment to add participants
                        const currentShipment = getShipmentBySpaceId(spaceId);
                        if (currentShipment) {
                            participantsToAdd.forEach(participant => {
                                if (currentShipment.addParticipant) {
                                    currentShipment.addParticipant(participant.userId, participant.role, participant.invitedBy);
                                } else {
                                    // Fallback if addParticipant method doesn't exist
                                    if (!currentShipment.participants) {
                                        currentShipment.participants = [];
                                    }
                                    const existing = currentShipment.participants.find(p => p.userId === participant.userId);
                                    if (!existing) {
                                        currentShipment.participants.push({
                                            userId: participant.userId,
                                            role: participant.role,
                                            invitedAt: new Date().toISOString(),
                                            invitedBy: participant.invitedBy
                                        });
                                    }
                                }
                            });
                            // Update participants in the updates object
                            updates.participants = currentShipment.participants;
                        }
                    }
                    
                    const result = updateShipment(spaceId, updates);
                    if (result.success) {
                        shipmentUpdated = true;
                        sessionStorage.setItem('currentShipmentAWB', result.shipment.awbNumber);
                        console.log('✅✅✅ SHIPMENT SPACE UPDATED WITH AWB:', result.shipment.awbNumber);
                        console.log('All form fields, dropdowns, and PDF stored in space:', spaceId);
                        
                        // Hide loading, show success
                        if (loadingEl) {
                            loadingEl.style.display = 'none';
                        }
                        if (errorEl) {
                            errorEl.style.display = 'block';
                            errorEl.style.background = '#28a745';
                            errorEl.style.color = 'white';
                            errorEl.textContent = '✓ AWB created successfully! Redirecting...';
                        }
                        
                        // Redirect back to space after a short delay
                        setTimeout(() => {
                            if (window.parent && window.parent !== window) {
                                const contentFrame = window.parent.document.getElementById('contentFrame');
                                if (contentFrame) {
                                    contentFrame.src = `shipments/space.html?spaceId=${spaceId}`;
                                } else {
                                    window.location.href = `shipments/space.html?spaceId=${spaceId}`;
                                }
                            } else {
                                window.location.href = `shipments/space.html?spaceId=${spaceId}`;
                            }
                        }, 1500);
                    } else {
                        console.error('Error updating shipment:', result.message);
                        
                        // Hide loading, show error
                        if (loadingEl) {
                            loadingEl.style.display = 'none';
                        }
                        if (errorEl) {
                            errorEl.style.display = 'block';
                            errorEl.style.background = '#dc3545';
                            errorEl.style.color = 'white';
                            errorEl.textContent = 'Error saving AWB: ' + result.message;
                        }
                        if (contentWrapper) {
                            contentWrapper.style.opacity = '1';
                            contentWrapper.style.pointerEvents = 'auto';
                        }
                        if (createBtn) {
                            createBtn.disabled = false;
                            createBtn.textContent = 'Create AWB';
                        }
                        
                        alert('Error saving AWB: ' + result.message);
                    }
                } catch (saveError) {
                    console.error('Error saving AWB to shipment space:', saveError);
                    
                    // Hide loading, show error
                    if (loadingEl) {
                        loadingEl.style.display = 'none';
                    }
                    if (errorEl) {
                        errorEl.style.display = 'block';
                        errorEl.style.background = '#dc3545';
                        errorEl.style.color = 'white';
                        errorEl.textContent = 'Error: ' + (saveError.message || 'An unexpected error occurred');
                    }
                    if (contentWrapper) {
                        contentWrapper.style.opacity = '1';
                        contentWrapper.style.pointerEvents = 'auto';
                    }
                    if (createBtn) {
                        createBtn.disabled = false;
                        createBtn.textContent = 'Create AWB';
                    }
                    
                    alert('Error saving AWB: ' + (saveError.message || 'An unexpected error occurred'));
                }
            }
            
            // Legacy function for creating new shipment (when no spaceId)
            async function createNewShipment() {
                if (typeof createShipment === 'undefined') {
                    alert('Error: Shipment creation function not available. Please refresh the page.');
                    return;
                }
                
                // Show loading state
                const loadingEl = document.getElementById('loading');
                const errorEl = document.getElementById('error');
                const contentWrapper = document.getElementById('contentWrapper');
                if (loadingEl) {
                    loadingEl.style.display = 'block';
                }
                if (errorEl) {
                    errorEl.style.display = 'none';
                }
                if (contentWrapper) {
                    contentWrapper.style.opacity = '0.5';
                    contentWrapper.style.pointerEvents = 'none';
                }
                
                try {
                    const completeFormData = collectCompleteFormData();
                    const formData = completeFormData.formData;
                    const pdfBytes = await fillPdfWithData(formData, true);
                    
                    const uint8Array = new Uint8Array(pdfBytes);
                    let binaryString = '';
                    const chunkSize = 8192;
                    for (let i = 0; i < uint8Array.length; i += chunkSize) {
                        const chunk = uint8Array.slice(i, i + chunkSize);
                        binaryString += String.fromCharCode.apply(null, chunk);
                    }
                    const pdfBase64 = btoa(binaryString);
                    
                    let awbNumberFromForm = null;
                    for (const key in formData) {
                        if (key.startsWith('101') && formData[key]) {
                            const value = String(formData[key]).trim();
                            if (value && value.includes('-')) {
                                awbNumberFromForm = value;
                                break;
                            }
                        }
                    }
                    
                    const shipmentOptions = { 
                        formData: completeFormData,
                        pdfBase64: pdfBase64,
                        pdfCreatedAt: new Date().toISOString()
                    };
                    if (awbNumberFromForm) {
                        shipmentOptions.awbNumber = awbNumberFromForm;
                    }
                    
                    const result = createShipment(shipmentOptions);
                    if (result.success) {
                        shipmentUpdated = true;
                        console.log('✅ Shipment created (legacy mode):', result.shipment.awbNumber);
                        
                        // Hide loading, show success
                        if (loadingEl) {
                            loadingEl.style.display = 'none';
                        }
                        if (errorEl) {
                            errorEl.style.display = 'block';
                            errorEl.style.background = '#28a745';
                            errorEl.style.color = 'white';
                            errorEl.textContent = '✓ AWB created successfully!';
                        }
                        
                        // Redirect to shipments list
                        setTimeout(() => {
                            if (window.parent && window.parent !== window) {
                                const contentFrame = window.parent.document.getElementById('contentFrame');
                                if (contentFrame) {
                                    contentFrame.src = 'shipments/list.html';
                                } else {
                                    window.location.href = 'shipments/list.html';
                                }
                            } else {
                                window.location.href = 'shipments/list.html';
                            }
                        }, 1500);
                    } else {
                        throw new Error(result.message || 'Failed to create shipment');
                    }
                } catch (error) {
                    console.error('Error creating shipment:', error);
                    
                    // Hide loading, show error
                    if (loadingEl) {
                        loadingEl.style.display = 'none';
                    }
                    if (errorEl) {
                        errorEl.style.display = 'block';
                        errorEl.style.background = '#dc3545';
                        errorEl.style.color = 'white';
                        errorEl.textContent = 'Error: ' + (error.message || 'Failed to create shipment');
                    }
                    if (contentWrapper) {
                        contentWrapper.style.opacity = '1';
                        contentWrapper.style.pointerEvents = 'auto';
                    }
                    
                    alert('Error creating shipment: ' + (error.message || 'An unexpected error occurred'));
                }
            }
            
        })();
    </script>
</body>
</html>
