<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payment Center - Airway Bills</title>
    <link rel="stylesheet" href="../styles.css">
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            margin-top: 0;
            color: #333;
        }
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }
        .summary-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .summary-card h3 {
            margin: 0 0 10px 0;
            font-size: 14px;
            opacity: 0.9;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .summary-card .amount {
            font-size: 32px;
            font-weight: bold;
            margin: 0;
        }
        .shipments-list {
            margin-top: 30px;
        }
        .shipment-item {
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
            background: #fff;
        }
        .shipment-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }
        .shipment-awb {
            font-size: 18px;
            font-weight: bold;
            color: #667eea;
        }
        .fee-breakdown {
            margin: 15px 0;
        }
        .fee-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #f0f0f0;
        }
        .fee-item:last-child {
            border-bottom: 2px solid #333;
            font-weight: bold;
            font-size: 18px;
            margin-top: 10px;
            padding-top: 15px;
        }
        .btn-pay {
            background: #28a745;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 15px;
        }
        .btn-pay:hover {
            background: #218838;
        }
        .btn-pay:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .paid-badge {
            background: #28a745;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ðŸ’³ Payment Center</h1>
        <p>View and manage payments for shipments</p>
        
        <div class="summary-cards">
            <div class="summary-card">
                <h3>Total Pending</h3>
                <p class="amount" id="totalPending">$0.00</p>
            </div>
            <div class="summary-card" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%);">
                <h3>Total Paid</h3>
                <p class="amount" id="totalPaid">$0.00</p>
            </div>
            <div class="summary-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                <h3>Total Shipments</h3>
                <p class="amount" id="totalShipments">0</p>
            </div>
        </div>
        
        <div id="shipmentsList" class="shipments-list">
            <div class="empty-state">
                <h2>Loading payments...</h2>
            </div>
        </div>
    </div>

    <!-- Load required scripts -->
    <script src="../models/user.js"></script>
    <script src="../models/shipment.js"></script>
    <script src="../js/roles.js"></script>
    <script src="../js/auth.js"></script>
    <script src="../js/shipments.js"></script>
    
    <script>
        // Check authentication and role
        if (!requireAuth()) {
            exit;
        }

        const user = getCurrentUser();
        if (!user) {
            window.location.href = '../login.html';
            exit;
        }

        if (user.role !== 'consignee') {
            alert('This page is only accessible to Consignees');
            window.location.href = '../dashboard.html';
            exit;
        }

        // Load and display shipments with payment info
        function loadPayments() {
            const shipments = getUserShipments(user.id);
            
            // Calculate totals
            let totalPending = 0;
            let totalPaid = 0;
            
            shipments.forEach(s => {
                if (s.paidBy) {
                    totalPaid += (s.totalFees || 0);
                } else {
                    totalPending += (s.totalFees || 0);
                }
            });
            
            document.getElementById('totalPending').textContent = `$${totalPending.toFixed(2)}`;
            document.getElementById('totalPaid').textContent = `$${totalPaid.toFixed(2)}`;
            document.getElementById('totalShipments').textContent = shipments.length;
            
            const container = document.getElementById('shipmentsList');
            
            if (shipments.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h2>No shipments found</h2>
                        <p>You haven't been assigned to any shipments yet.</p>
                    </div>
                `;
                return;
            }
            
            // Sort: pending first, then paid
            shipments.sort((a, b) => {
                if (a.paidBy && !b.paidBy) return 1;
                if (!a.paidBy && b.paidBy) return -1;
                return new Date(b.createdAt) - new Date(a.createdAt);
            });
            
            container.innerHTML = shipments.map(shipment => {
                const createdDate = new Date(shipment.createdAt).toLocaleDateString();
                const fees = shipment.fees || [];
                const totalFees = shipment.totalFees || 0;
                const isPaid = !!shipment.paidBy;
                const paidDate = shipment.paidAt ? new Date(shipment.paidAt).toLocaleDateString() : null;
                
                return `
                    <div class="shipment-item">
                        <div class="shipment-header">
                            <div>
                                <div class="shipment-awb">AWB: ${shipment.awbNumber}</div>
                                <div style="font-size: 14px; color: #666; margin-top: 5px;">Created: ${createdDate}</div>
                            </div>
                            <div>
                                ${isPaid ? `<span class="paid-badge">âœ“ Paid on ${paidDate}</span>` : ''}
                            </div>
                        </div>
                        
                        <div class="fee-breakdown">
                            <h3 style="margin-top: 0; color: #333;">Fee Breakdown</h3>
                            ${fees.length > 0 ? fees.map(fee => `
                                <div class="fee-item">
                                    <span>${getRoleLabel(fee.role)} - ${fee.description || 'Service fee'}</span>
                                    <span>$${parseFloat(fee.amount || 0).toFixed(2)}</span>
                                </div>
                            `).join('') : '<p style="color: #999;">No fees added yet</p>'}
                            <div class="fee-item">
                                <span>Total</span>
                                <span>$${totalFees.toFixed(2)}</span>
                            </div>
                        </div>
                        
                        ${!isPaid ? `
                            <button class="btn-pay" onclick="processPayment('${shipment.awbNumber}', ${totalFees})">
                                Pay $${totalFees.toFixed(2)}
                            </button>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }
        
        function processPayment(awbNumber, amount) {
            if (confirm(`Process payment of $${amount.toFixed(2)} for AWB ${awbNumber}?`)) {
                // In a real system, this would integrate with a payment gateway
                // For now, just mark as paid
                const result = updateShipment(awbNumber, {
                    status: 'completed',
                    paidBy: user.id,
                    paidAt: new Date().toISOString()
                });
                
                if (result.success) {
                    alert(`Payment of $${amount.toFixed(2)} processed successfully!`);
                    loadPayments(); // Reload to update totals
                } else {
                    alert('Error processing payment: ' + result.message);
                }
            }
        }
        
        // Load payments on page load
        loadPayments();
    </script>
</body>
</html>
